name: Ramadan Series Extractor

on:
  workflow_dispatch:  # ุชุดุบูู ูุฏูู
  schedule:
    # ุชุดุบูู ูู ุณุงุนุฉ
    - cron: "0 * * * *"  # ูู ุณุงุนุฉ ุนูุฏ ุงูุฏูููุฉ 0

jobs:
  extract-ramadan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: |
          npm install jsdom
          echo "โ ุชู ุชุซุจูุช ุงูุญุฒู ุงููุทููุจุฉ"

      - name: Create Ramadan directory
        run: |
          # ุฅูุดุงุก ูุฌูุฏ Ramadan ูุณุจูุงู ุฅุฐุง ูู ููู ููุฌูุฏุงู
          mkdir -p Ramadan
          echo "๐ ุชู ุฅูุดุงุก/ุงูุชุฃูุฏ ูู ูุฌูุฏ ูุฌูุฏ Ramadan"

      - name: Run Ramadan.js
        run: |
          echo "๐ ุจุฏุก ุนูููุฉ ุงุณุชุฎุฑุงุฌ ูุณูุณูุงุช ุฑูุถุงู..."
          echo "โฐ ุงูููุช ุงูุญุงูู: $(date)"
          echo "๐ ุงูุฌุฏููุฉ: ูู ุณุงุนุฉ (ุนูู ุงูุฏูููุฉ 0)"
          echo "๐ ุงูููู: Ramadan.js"
          
          # ุงูุชุญูู ูู ูุฌูุฏ ุงูููู
          if [ -f "Ramadan.js" ]; then
            echo "โ Ramadan.js ููุฌูุฏุ ุฌุงุฑู ุงูุชุดุบูู..."
            
            # ุชุดุบูู ููู Ramadan.js
            node Ramadan.js
            
            echo "โ ุชู ุชุดุบูู Ramadan.js ุจูุฌุงุญ"
          else
            echo "โ ููู Ramadan.js ุบูุฑ ููุฌูุฏ!"
            echo "๐ ุงููููุงุช ุงูููุฌูุฏุฉ:"
            ls -la *.js || echo "ูุง ุชูุฌุฏ ูููุงุช js"
            exit 1
          fi
          
          echo "โ ุชู ุงูุงูุชูุงุก ูู ุงุณุชุฎุฑุงุฌ ูุณูุณูุงุช ุฑูุถุงู"

      - name: Check results
        run: |
          echo "๐ ====== ูุชุงุฆุฌ ุงุณุชุฎุฑุงุฌ ุฑูุถุงู ======"
          echo "โฐ ููุช ุงูุชุดุบูู: $(date)"
          
          YEAR="2025"  # ููุณ ุงูุณูุฉ ุงููุญุฏุฏุฉ ูู ุงูููุฏ
          
          # ุงูุชุญูู ูู ูุฌูุฏ ูุฌูุฏ ุงูุณูุฉ
          if [ -d "Ramadan/$YEAR" ]; then
            echo "โ ูุฌูุฏ ุงูุณูุฉ $YEAR ููุฌูุฏ"
            
            # ุนุฑุถ ูุญุชููุงุช ูุฌูุฏ ุงูุณูุฉ
            echo ""
            echo "๐ ูุญุชููุงุช ูุฌูุฏ $YEAR:"
            ls -la "Ramadan/$YEAR/" | head -20
            
            # ุงูุชุญูู ูู ูุฌูุฏ ููู ุงูููุฑุณ
            if [ -f "Ramadan/$YEAR/index_$YEAR.json" ]; then
              echo ""
              echo "๐ ููู ุงูููุฑุณ ููุฌูุฏ"
              echo "๐ ุญุฌู ููู ุงูููุฑุณ: $(wc -c < Ramadan/$YEAR/index_$YEAR.json) ุจุงูุช"
              
              # ุนุฑุถ ูุนูููุงุช ุงูููุฑุณ ุจุงุณุชุฎุฏุงู jq
              echo ""
              echo "๐ ุฅุญุตุงุฆูุงุช ุงููุณูุณูุงุช:"
              if command -v jq &> /dev/null; then
                jq '{year: .year, totalSeries: .totalSeries, totalEpisodes: .totalEpisodes, scrapedAt: .scrapedAt}' "Ramadan/$YEAR/index_$YEAR.json"
                
                # ุนุฑุถ ุฃูู 3 ูุณูุณูุงุช
                echo ""
                echo "๐ฌ ุฃูู 3 ูุณูุณูุงุช:"
                jq '.series[0:3]' "Ramadan/$YEAR/index_$YEAR.json"
              else
                echo "โ jq ุบูุฑ ูุซุจุชุ ุชุซุจูุชู..."
                sudo apt-get update && sudo apt-get install -y jq
                jq '{year: .year, totalSeries: .totalSeries, totalEpisodes: .totalEpisodes, scrapedAt: .scrapedAt}' "Ramadan/$YEAR/index_$YEAR.json"
              fi
            else
              echo "โ ููู ุงูููุฑุณ ุบูุฑ ููุฌูุฏ ูู Ramadan/$YEAR/"
            fi
          else
            echo "โ ูุฌูุฏ ุงูุณูุฉ $YEAR ุบูุฑ ููุฌูุฏ"
            echo "๐ ูุญุชููุงุช ูุฌูุฏ Ramadan:"
            if [ -d "Ramadan" ]; then
              ls -la Ramadan/
            else
              echo "โ ูุฌูุฏ Ramadan ุบูุฑ ููุฌูุฏ"
            fi
          fi

      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # ุฅุถุงูุฉ ูุงูุฉ ุงูุชุบููุฑุงุช ูู ูุฌูุฏ Ramadan
          git add Ramadan/ || echo "โ๏ธ ูุง ููุฌุฏ ุชุบููุฑุงุช ูู ูุฌูุฏ Ramadan"
          
          # ุงูุชุญูู ุฅุฐุง ูุงูุช ููุงู ุชุบููุฑุงุช
          if git diff --cached --quiet; then
            echo "๐ญ ูุง ุชูุฌุฏ ุชุบููุฑุงุช ุฌุฏูุฏุฉ ููุฑูุน"
          else
            echo "๐ผ ุฑูุน ุงูุชุบููุฑุงุช ุงูุฌุฏูุฏุฉ..."
            
            # ุงูุญุตูู ุนูู ุนุฏุฏ ุงููููุงุช ุงูุฌุฏูุฏุฉ
            NEW_FILES=$(git diff --cached --name-only | wc -l)
            TIMESTAMP=$(date +"%Y-%m-%d %H:%M")
            
            git commit -m "๐ ุชุญุฏูุซ ูุณูุณูุงุช ุฑูุถุงู ุชููุงุฆู - $TIMESTAMP" \
                       -m "ุชู ุงุณุชุฎุฑุงุฌ $NEW_FILES ููู/ูููุงุช ุฌุฏูุฏุฉ" \
                       -m "ุฌุฏููุฉ ุงูุชุดุบูู: ูู ุณุงุนุฉ"
            git push
            echo "โ ุชู ุฑูุน ุงูุชุบููุฑุงุช ุจูุฌุงุญ"
            
            # ุฅุฑุณุงู ุฅุดุนุงุฑ ุจุงูุชุบููุฑุงุช
            echo ""
            echo "๐จ ููุฎุต ุงูุชุบููุฑุงุช:"
            echo "   โข ุงูููุช: $TIMESTAMP"
            echo "   โข ุงููููุงุช ุงููุถุงูุฉ/ุงููุญุฏุซุฉ: $NEW_FILES"
          fi

      - name: Send notification (ุงุฎุชูุงุฑู)
        if: success()
        run: |
          echo "๐ข ุชู ุชูููุฐ ุงููููุฉ ุจูุฌุงุญ!"
          echo "๐ฐ  ุงูุชูููุช: $(date)"
          echo "๐ ุงูุชุดุบูู ุงูุชุงูู: ุจุนุฏ ุณุงุนุฉ ูุงุญุฏุฉ"
          echo ""
          echo "ููููู ุชุนุทูู ุงูุฅุดุนุงุฑุงุช ูู ููู workflow ุฅุฐุง ููุช ูุง ุชุฑูุฏูุง"

  # (ุงุฎุชูุงุฑู) ูููุฉ ููุชุญูู ูู ููุฏ Ramadan.js ูุจู ุงูุชูููุฐ
  lint-check:
    runs-on: ubuntu-latest
    needs: [extract-ramadan]  # ุชุนูู ุจุนุฏ extract-ramadan
    if: always()  # ุชุนูู ุฏุงุฆููุง ุญุชู ูู ูุดูุช ุงููููุฉ ุงูุณุงุจูุฉ
    
    steps:
      - name: Check Ramadan.js syntax
        run: |
          echo "๐ ูุญุต ููุฏ Ramadan.js..."
          if [ -f "Ramadan.js" ]; then
            # ูุญุต ุจูุงุก ุงูุฌููุฉ ุงูุฃุณุงุณู
            node -c Ramadan.js && echo "โ ุจูุงุก ุงูุฌููุฉ ุตุญูุญ" || echo "โ ุฎุทุฃ ูู ุจูุงุก ุงูุฌููุฉ"
          else
            echo "โ๏ธ ููู Ramadan.js ุบูุฑ ููุฌูุฏ"
          fi
