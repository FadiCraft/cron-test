name: Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø­Ù„Ù‚Ø§Øª Ø±Ù…Ø¶Ø§Ù† Ù…Ù† Ù„Ø§Ø±ÙˆØ²Ø§

on:
  schedule:
    # ÙƒÙ„ 10 Ø¯Ù‚Ø§Ø¦Ù‚
    - cron: '*/10 * * * *'
  workflow_dispatch:  # Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ
  push:
    branches: [ main, master ]

jobs:
  extract-episodes:
    name: Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø­Ù„Ù‚Ø§Øª
    runs-on: ubuntu-latest
    
    steps:
      - name: â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
        uses: actions/checkout@v3
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: ðŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ÙŠØ§Øª
        run: |
          npm init -y
          npm install node-html-parser

      - name: ðŸ—‚ï¸ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ù„Ù„Ø­Ù„Ù‚Ø§Øª
        run: |
          mkdir -p Ramadan
          mkdir -p logs

      - name: ðŸš€ ØªØ´ØºÙŠÙ„ Ù…Ø³ØªØ®Ø±Ø¬ Ø§Ù„Ø­Ù„Ù‚Ø§Øª
        id: run_extractor
        continue-on-error: true
        run: |
          echo "â° Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„: $(date)" > logs/last_run.log
          node Ramadan.js >> logs/output.log 2>&1
          echo "âœ… ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡: $(date)" >> logs/last_run.log

      - name: ðŸ“Š Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØºÙŠÙŠØ±Ø§Øª
        id: check_changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add Ramadan/ logs/
          if git diff --staged --quiet; then
            echo "ðŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù„Ù‚Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø­ÙØ¸"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "ðŸ“¦ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ù„Ù‚Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©!"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“¤ Ø±ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: ad-m/github-push-action@v0.8.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
          force: true
          directory: .

      - name: ðŸ“ˆ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        if: always()
        run: |
          echo "ðŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„ØªØ´ØºÙŠÙ„:" >> $GITHUB_STEP_SUMMARY
          echo "- Ø§Ù„ÙˆÙ‚Øª: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- Ø§Ù„Ø­Ø§Ù„Ø©: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          cat logs/last_run.log >> $GITHUB_STEP_SUMMARY
