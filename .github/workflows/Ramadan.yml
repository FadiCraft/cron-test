name: Ramadan Series Scraper

on:
  workflow_dispatch:  # ุชุดุบูู ูุฏูู
  schedule:
    # ุชุดุบูู ูู ุณุงุนุฉ
    - cron: "0 * * * *"  # ูู ุณุงุนุฉ ูู ุงูุฏูููุฉ 0

jobs:
  extract-ramadan-series:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Show directory structure
        run: |
          echo "๐ ูููู ุงููููุงุช ุงูุญุงูู:"
          pwd
          ls -la
          echo ""
          echo "๐ ูุญุชููุงุช ุงููุฌูุฏ ุงูุญุงูู:"
          find . -name "*.js" -o -name "*.json" | head -20

      - name: Install dependencies
        run: |
          echo "๐ฆ ุชุซุจูุช ุงูุงุนุชูุงุฏูุงุช..."
          npm init -y
          npm install jsdom
          npm list jsdom
          echo "โ ุชู ุชุซุจูุช ุงูุญุฒู ุงููุทููุจุฉ"

      - name: Create Ramadan directory
        run: |
          echo "๐ง ุฅูุดุงุก ุงููุฌูุฏุงุช..."
          mkdir -p Ramadan/2025
          echo "๐ ุชู ุฅูุดุงุก ูุฌูุฏ Ramadan/2025"
          echo ""
          echo "๐ ุงูุชุญูู ูู ุงููุฌูุฏุงุช:"
          ls -la Ramadan/ || echo "ูุฌูุฏ Ramadan ุบูุฑ ููุฌูุฏ"
          ls -la Ramadan/2025/ 2>/dev/null || echo "ูุฌูุฏ 2025 ุบูุฑ ููุฌูุฏ"

      - name: Test file creation
        run: |
          echo "โ๏ธ ุงุฎุชุจุงุฑ ุฅูุดุงุก ููู..."
          echo "ูุฐุง ููู ุงุฎุชุจุงุฑู ูู GitHub Actions - $(date)" > Ramadan/2025/test_actions.txt
          echo "โ ุชู ุฅูุดุงุก ููู ุงุฎุชุจุงุฑู"
          echo ""
          echo "๐ ูุญุชููุงุช Ramadan/2025 ุจุนุฏ ุงูุงุฎุชุจุงุฑ:"
          ls -la Ramadan/2025/

      - name: Run Ramadan.js
        run: |
          echo "๐ฌ ุจุฏุก ุงุณุชุฎุฑุงุฌ ูุณูุณูุงุช ุฑูุถุงู..."
          echo "๐ ุงูุณูุฉ: 2025"
          echo "โฐ ุงูููุช: $(date)"
          echo "๐ ุงูุฌุฏููุฉ: ูู ุณุงุนุฉ"
          echo "๐ ุงูููู: Ramadan.js"
          echo "๐ ุงููุณุงุฑ ุงูุญุงูู: $(pwd)"
          echo ""
          
          # ุงูุชุญูู ูู ูุฌูุฏ ุงูููู
          if [ -f "Ramadan.js" ]; then
            echo "โ ููู Ramadan.js ููุฌูุฏ"
            echo "๐ ุญุฌู ุงูููู: $(wc -l < Ramadan.js) ุณุทุฑ"
            echo ""
            echo "๐ ุฌุงุฑู ุงูุชุดุบูู..."
            
            # ุชุดุบูู ูุน ุชุณุฌูู ููุตู
            node Ramadan.js 2>&1 | tee output.log
            
            EXIT_CODE=${PIPESTATUS[0]}
            echo ""
            echo "๐ ููุฏ ุงูุฎุฑูุฌ: $EXIT_CODE"
            
            if [ $EXIT_CODE -eq 0 ]; then
              echo "โ ุชู ุชุดุบูู Ramadan.js ุจูุฌุงุญ"
            else
              echo "โ Ramadan.js ุฎุฑุฌ ุจุฑูุฒ ุฎุทุฃ: $EXIT_CODE"
              echo ""
              echo "๐ ุขุฎุฑ 50 ุณุทุฑ ูู ุงูุฅุฎุฑุงุฌ:"
              tail -50 output.log
              exit $EXIT_CODE
            fi
          else
            echo "โ ููู Ramadan.js ุบูุฑ ููุฌูุฏ!"
            echo ""
            echo "๐ ุงููููุงุช ุงูููุฌูุฏุฉ:"
            ls -la *.js || echo "ูุง ุชูุฌุฏ ูููุงุช js"
            exit 1
          fi
          
          echo "โ ุชู ุงูุงูุชูุงุก ูู ุงุณุชุฎุฑุงุฌ ูุณูุณูุงุช ุฑูุถุงู"

      - name: Check results
        run: |
          echo "๐ ====== ูุชุงุฆุฌ ุงุณุชุฎุฑุงุฌ ูุณูุณูุงุช ุฑูุถุงู ======"
          echo "โฐ ููุช ุงูุชุดุบูู: $(date)"
          echo "๐ ุงูุชูุฑุงุฑ: ูู ุณุงุนุฉ"
          echo "๐ ุงูุณูุฉ: 2025"
          echo ""
          
          # ุนุฑุถ ุงูุฅุฎุฑุงุฌ ุงููุงูู
          echo "๐ ุฅุฎุฑุงุฌ ุงูุจุฑูุงูุฌ:"
          cat output.log 2>/dev/null || echo "โ๏ธ ูุง ููุฌุฏ ููู output.log"
          
          echo ""
          echo "๐ ุงูุชุญูู ูู ุงููููุงุช ุงูููุดุฃุฉ..."
          
          # ุงูุชุญูู ูู ูุฌูุฏ ูุฌูุฏ Ramadan/2025
          if [ -d "Ramadan/2025" ]; then
            echo "โ ูุฌูุฏ Ramadan/2025 ููุฌูุฏ"
            echo ""
            echo "๐ ูุญุชููุงุช Ramadan/2025:"
            ls -la Ramadan/2025/
            echo ""
            echo "๐ ูุงุฆูุฉ ูููุงุช JSON:"
            find Ramadan/2025 -name "*.json" -type f
            
            # ุงูุชุญูู ูู ูุฌูุฏ ููู index_2025.json
            if [ -f "Ramadan/2025/index_2025.json" ]; then
              echo ""
              echo "โ ุชู ุฅูุดุงุก ููู index_2025.json"
              
              # ุชุซุจูุช jq
              sudo apt-get update && sudo apt-get install -y jq
              
              # ุนุฑุถ ูุนูููุงุช ุงูููุฑุณ
              echo ""
              echo "๐ ูุนูููุงุช ุงูููุฑุณ:"
              jq '.' Ramadan/2025/index_2025.json
              
            else
              echo "โ ูู ูุชู ุฅูุดุงุก index_2025.json"
            fi
          else
            echo "โ ูุฌูุฏ Ramadan/2025 ุบูุฑ ููุฌูุฏ!"
          fi

      - name: Save output log
        if: always()
        run: |
          echo "๐ ุญูุธ ุณุฌู ุงูุฅุฎุฑุงุฌ..."
          mkdir -p logs
          cp output.log logs/ramadan_$(date +%Y%m%d_%H%M%S).log 2>/dev/null || echo "โ๏ธ ูุง ููุฌุฏ output.log"
          echo "โ ุชู ุญูุธ ุงูุณุฌู"

      - name: Commit and push changes
        if: success()
        run: |
          echo "๐ ุชุญุถูุฑ ุงูุชุญุฏูุซุงุช..."
          
          # ุชูููู Git
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # ุฅุถุงูุฉ ุฌููุน ุงููููุงุช ุงูุฌุฏูุฏุฉ
          echo "โ ุฅุถุงูุฉ ุงููููุงุช..."
          git add Ramadan/ || echo "โ๏ธ ูุง ุชูุฌุฏ ูููุงุช ูู Ramadan"
          git add logs/ 2>/dev/null || echo "โ๏ธ ูุง ุชูุฌุฏ ุณุฌูุงุช"
          git add output.log 2>/dev/null || echo "โ๏ธ ูุง ููุฌุฏ output.log"
          
          # ุงูุชุญูู ูู ุงูุชุบููุฑุงุช
          echo "๐ ุงูุชุญูู ูู ุงูุชุบููุฑุงุช..."
          git status
          
          if git diff --cached --quiet; then
            echo "๐ญ ูุง ุชูุฌุฏ ุชุบููุฑุงุช ุฌุฏูุฏุฉ ููุฑูุน"
          else
            echo "๐ผ ุฑูุน ุงูุชุบููุฑุงุช..."
            
            # ุฅูุดุงุก ุฑุณุงูุฉ ุงูู commit
            COMMIT_MSG="๐ฌ ุชุญุฏูุซ ูุณูุณูุงุช ุฑูุถุงู 2025 - $(date +'%Y-%m-%d %H:%M')"
            
            # ุฅุถุงูุฉ ูุนูููุงุช ุฅุถุงููุฉ ุฅุฐุง ูุงู ููุงู ููู ููุฑุณ
            if [ -f "Ramadan/2025/index_2025.json" ]; then
              TOTAL_SERIES=$(jq -r '.totalSeries // 0' Ramadan/2025/index_2025.json 2>/dev/null || echo 0)
              TOTAL_EPISODES=$(jq -r '.totalEpisodes // 0' Ramadan/2025/index_2025.json 2>/dev/null || echo 0)
              
              COMMIT_MSG="$COMMIT_MSG
ุชุญุฏูุซ ุชููุงุฆู ูู ุณุงุนุฉ
ุนุฏุฏ ุงููุณูุณูุงุช: $TOTAL_SERIES
ุนุฏุฏ ุงูุญููุงุช: $TOTAL_EPISODES"
            fi
            
            git commit -m "$COMMIT_MSG"
            git push
            echo "โ ุชู ุฑูุน ุงูุชุบููุฑุงุช"
          fi

      - name: Final status
        run: |
          echo ""
          echo "๐ ====== ุงูุญุงูุฉ ุงูููุงุฆูุฉ ======"
          echo "โ ุงูุชูู ุงูุนูู ุจูุฌุงุญ"
          echo "โฐ ุงูููุช: $(date)"
          echo "๐ ูููุน ุงููููุงุช: Ramadan/2025/"
          
          # ุนุฏ ุงููููุงุช
          if [ -d "Ramadan/2025" ]; then
            FILE_COUNT=$(find Ramadan/2025 -type f | wc -l)
            JSON_COUNT=$(find Ramadan/2025 -name "*.json" | wc -l)
            echo "๐ ุฅุฌูุงูู ุงููููุงุช: $FILE_COUNT"
            echo "๐ ูููุงุช JSON: $JSON_COUNT"
          fi
