name: Ramadan Series Scraper

on:
  workflow_dispatch:  # ุชุดุบูู ูุฏูู
  schedule:
    # ุชุดุบูู ูู ุณุงุนุฉ
    - cron: "0 * * * *"  # ูู ุณุงุนุฉ ูู ุงูุฏูููุฉ 0

jobs:
  extract-ramadan-series:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: |
          npm install jsdom
          echo "โ ุชู ุชุซุจูุช ุงูุญุฒู ุงููุทููุจุฉ"

      - name: Create Ramadan directory
        run: |
          # ุฅูุดุงุก ูุฌูุฏ Ramadan/2025 ูุณุจูุงู
          mkdir -p Ramadan/2025
          echo "๐ ุชู ุฅูุดุงุก ูุฌูุฏ Ramadan/2025"

      - name: Run Ramadan.js
        run: |
          echo "๐ฌ ุจุฏุก ุงุณุชุฎุฑุงุฌ ูุณูุณูุงุช ุฑูุถุงู..."
          echo "๐ ุงูุณูุฉ: 2025"
          echo "โฐ ุงูููุช: $(date)"
          echo "๐ ุงูุฌุฏููุฉ: ูู ุณุงุนุฉ"
          echo "๐ ุงูููู: Ramadan.js"
          echo "๐ ุฌุงุฑู ุงูุชุดุบูู..."
          
          # ุชุดุบูู ููู Ramadan.js
          if [ -f "Ramadan.js" ]; then
            node Ramadan.js
            EXIT_CODE=$?
            if [ $EXIT_CODE -eq 0 ]; then
              echo "โ ุชู ุชุดุบูู Ramadan.js ุจูุฌุงุญ"
            else
              echo "โ Ramadan.js ุฎุฑุฌ ุจุฑูุฒ ุฎุทุฃ: $EXIT_CODE"
              exit $EXIT_CODE
            fi
          else
            echo "โ ููู Ramadan.js ุบูุฑ ููุฌูุฏ!"
            echo "๐ ุงููููุงุช ุงูููุฌูุฏุฉ:"
            ls -la *.js || echo "ูุง ุชูุฌุฏ ูููุงุช js"
            exit 1
          fi
          
          echo "โ ุชู ุงูุงูุชูุงุก ูู ุงุณุชุฎุฑุงุฌ ูุณูุณูุงุช ุฑูุถุงู"

      - name: Check results
        run: |
          echo "๐ ====== ูุชุงุฆุฌ ุงุณุชุฎุฑุงุฌ ูุณูุณูุงุช ุฑูุถุงู ======"
          echo "โฐ ููุช ุงูุชุดุบูู: $(date)"
          echo "๐ ุงูุชูุฑุงุฑ: ูู ุณุงุนุฉ"
          echo "๐ ุงูุณูุฉ: 2025"
          
          # ุงูุชุญูู ูู ูุฌูุฏ ููู index_2025.json
          if [ -f "Ramadan/2025/index_2025.json" ]; then
            echo "โ ุชู ุฅูุดุงุก/ุชุญุฏูุซ ููู index_2025.json"
            
            # ุชุซุจูุช jq ุฅุฐุง ูู ููู ูุซุจุชุงู
            if ! command -v jq &> /dev/null; then
              echo "๐ฆ ุชุซุจูุช jq ูุนุฑุถ ุงูุจูุงูุงุช..."
              sudo apt-get update && sudo apt-get install -y jq
            fi
            
            # ุนุฑุถ ูุนูููุงุช ุงูููุฑุณ
            echo ""
            echo "๐ ูุนูููุงุช ุงูููุฑุณ:"
            if jq -e '.totalSeries' Ramadan/2025/index_2025.json > /dev/null 2>&1; then
              TOTAL_SERIES=$(jq -r '.totalSeries' Ramadan/2025/index_2025.json)
              TOTAL_EPISODES=$(jq -r '.totalEpisodes' Ramadan/2025/index_2025.json)
              SCRAPED_AT=$(jq -r '.scrapedAt' Ramadan/2025/index_2025.json)
              
              echo "๐ฏ ุฅุฌูุงูู ุงููุณูุณูุงุช: $TOTAL_SERIES"
              echo "๐ฌ ุฅุฌูุงูู ุงูุญููุงุช: $TOTAL_EPISODES"
              echo "โฐ ููุช ุงูุงุณุชุฎุฑุงุฌ: $SCRAPED_AT"
              
              # ุนุฑุถ ุฃูู 3 ูุณูุณูุงุช
              echo ""
              echo "๐บ ุฃูู 3 ูุณูุณูุงุช ูุณุชุฎุฑุฌุฉ:"
              jq -r '.series[0:3] | .[] | "  - \(.title) (ID: \(.id)) | ุงูุญููุงุช: \(.episodes) | ุงูููู: \(.fileName)"' Ramadan/2025/index_2025.json
              
              # ุญุณุงุจ ุนุฏุฏ ุงููููุงุช ุงููุณูุณูุงุช ุงูููุดุฃุฉ
              SERIES_FILES_COUNT=$(ls -1 Ramadan/2025/*.json 2>/dev/null | grep -v index_2025.json | wc -l)
              echo ""
              echo "๐ ุงููููุงุช ุงูููุดุฃุฉ: $SERIES_FILES_COUNT ููู ูุณูุณู"
              
            else
              echo "โ๏ธ ูููู JSON ุบูุฑ ุตุงูุญ ุฃู ูุง ูุญุชูู ุนูู ุงูุจูุงูุงุช ุงููุชููุนุฉ"
            fi
            
            # ุนุฑุถ ุญุฌู ูุฌูุฏ Ramadan/2025
            echo ""
            echo "๐พ ุญุฌู ุงููุฌูุฏ:"
            du -sh Ramadan/2025/
            
          else
            echo "โ ูู ูุชู ุฅูุดุงุก index_2025.json"
            echo "๐ ูุญุชููุงุช ูุฌูุฏ Ramadan/2025:"
            if [ -d "Ramadan/2025" ]; then
              ls -la Ramadan/2025/
            else
              echo "โ ูุฌูุฏ Ramadan/2025 ุบูุฑ ููุฌูุฏ"
            fi
          fi
          
          # ุงูุชุญูู ูู ููู ูุณูุณู ููุซุงู
          FIRST_FILE=$(ls Ramadan/2025/*.json 2>/dev/null | grep -v index | head -1)
          if [ -n "$FIRST_FILE" ] && [ -f "$FIRST_FILE" ]; then
            echo ""
            echo "๐ ูุซุงู ุนูู ููู ูุณูุณู ($(basename $FIRST_FILE)):"
            SERIES_NAME=$(jq -r '.seriesTitle // "ุบูุฑ ูุนุฑูู"' "$FIRST_FILE" 2>/dev/null || echo "ุบูุฑ ูุนุฑูู")
            SERIES_EPISODES=$(jq -r '.totalEpisodes // 0' "$FIRST_FILE" 2>/dev/null || echo 0)
            FILE_SIZE=$(wc -c < "$FIRST_FILE")
            
            echo "  - ุงุณู ุงููุณูุณู: $SERIES_NAME"
            echo "  - ุนุฏุฏ ุงูุญููุงุช: $SERIES_EPISODES"
            echo "  - ุญุฌู ุงูููู: $FILE_SIZE ุจุงูุช"
            
            # ุนุฑุถ ุนุฏุฏ ุณูุฑูุฑุงุช ุงูุญููุฉ ุงูุฃููู
            FIRST_EPISODE_SERVERS=$(jq -r '.episodes[0].watchServers | length // 0' "$FIRST_FILE" 2>/dev/null || echo 0)
            echo "  - ุณูุฑูุฑุงุช ุงูุญููุฉ ุงูุฃููู: $FIRST_EPISODE_SERVERS"
          fi

      - name: Commit and push changes
        run: |
          # ุชูููู Git
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # ุฅุถุงูุฉ ุฌููุน ูููุงุช ุงููุณูุณูุงุช
          echo "๐ ุฅุถุงูุฉ ูููุงุช ุงููุณูุณูุงุช..."
          git add Ramadan/ || echo "โ๏ธ ูุง ุชูุฌุฏ ูููุงุช ุฌุฏูุฏุฉ"
          
          # ุงูุชุญูู ุฅุฐุง ูุงูุช ููุงู ุชุบููุฑุงุช
          if git diff --cached --quiet; then
            echo "๐ญ ูุง ุชูุฌุฏ ุชุบููุฑุงุช ุฌุฏูุฏุฉ ููุฑูุน"
          else
            echo "๐ผ ุฑูุน ุงูุชุบููุฑุงุช..."
            
            # ุฌูุจ ูุนูููุงุช ููุชุญุฏูุซ
            if [ -f "Ramadan/2025/index_2025.json" ]; then
              TOTAL_SERIES=$(jq -r '.totalSeries // 0' Ramadan/2025/index_2025.json 2>/dev/null || echo 0)
              TOTAL_EPISODES=$(jq -r '.totalEpisodes // 0' Ramadan/2025/index_2025.json 2>/dev/null || echo 0)
              TIMESTAMP=$(date +'%Y-%m-%d %H:%M')
              
              git commit -m "๐ฌ ุชุญุฏูุซ ูุณูุณูุงุช ุฑูุถุงู 2025 - $TIMESTAMP" \
                -m "ุชุญุฏูุซ ุชููุงุฆู ูู ุณุงุนุฉ" \
                -m "ุนุฏุฏ ุงููุณูุณูุงุช: $TOTAL_SERIES" \
                -m "ุนุฏุฏ ุงูุญููุงุช: $TOTAL_EPISODES"
            else
              git commit -m "๐ฌ ุชุญุฏูุซ ูุณูุณูุงุช ุฑูุถุงู - $(date +'%Y-%m-%d %H:%M')" \
                -m "ุชุญุฏูุซ ุชููุงุฆู ูู ุณุงุนุฉ"
            fi
            
            git push
            echo "โ ุชู ุฑูุน ุงูุชุบููุฑุงุช"
          fi

      - name: Create log file
        run: |
          # ุฅูุดุงุก ููู ุณุฌู
          TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
          LOG_FILE="Ramadan/2025/scrape_log.json"
          
          # ูุฑุงุกุฉ ูุนูููุงุช ุงูููุฑุณ
          if [ -f "Ramadan/2025/index_2025.json" ]; then
            TOTAL_SERIES=$(jq -r '.totalSeries // 0' Ramadan/2025/index_2025.json 2>/dev/null || echo 0)
            TOTAL_EPISODES=$(jq -r '.totalEpisodes // 0' Ramadan/2025/index_2025.json 2>/dev/null || echo 0)
            
            # ุญุณุงุจ ุนุฏุฏ ูููุงุช ุงููุณูุณูุงุช
            SERIES_FILES_COUNT=$(ls -1 Ramadan/2025/*.json 2>/dev/null | grep -v index_2025.json | grep -v scrape_log.json | wc -l)
            
            # ูุฑุงุกุฉ ุงูุจูุงูุงุช ุงูุญุงููุฉ ุฃู ุฅูุดุงุก ูุตูููุฉ ูุงุฑุบุฉ
            if [ -f "$LOG_FILE" ]; then
              # ุฅุถุงูุฉ ุณุฌู ุฌุฏูุฏ
              jq --arg timestamp "$TIMESTAMP" \
                 --argjson total_series "$TOTAL_SERIES" \
                 --argjson total_episodes "$TOTAL_EPISODES" \
                 --argjson series_files "$SERIES_FILES_COUNT" \
                 '. += [{
                   "timestamp": $timestamp,
                   "total_series": $total_series,
                   "total_episodes": $total_episodes,
                   "series_files": $series_files,
                   "year": "2025"
                 }]' \
                 "$LOG_FILE" > "$LOG_FILE.tmp" && mv "$LOG_FILE.tmp" "$LOG_FILE"
            else
              # ุฅูุดุงุก ููู ุณุฌู ุฌุฏูุฏ
              echo '[{
                "timestamp": "'$TIMESTAMP'",
                "total_series": '$TOTAL_SERIES',
                "total_episodes": '$TOTAL_EPISODES',
                "series_files": '$SERIES_FILES_COUNT',
                "year": "2025"
              }]' > "$LOG_FILE"
            fi
            
            # ุฅุถุงูุฉ ููู ุงูุณุฌู ุฅูู Git
            git add "$LOG_FILE"
            git commit -m "๐ ุชุญุฏูุซ ุณุฌู ุฑูุถุงู - $TIMESTAMP" || echo "โ๏ธ ูุง ุชูุฌุฏ ุชุบููุฑุงุช ูู ุงูุณุฌู"
            git push || echo "โ๏ธ ูุง ุชูุฌุฏ ุชุบููุฑุงุช ููุฑูุน"
            
            echo "๐ ุชู ุชุญุฏูุซ ุณุฌู ุงูุชุดุบูู"
          fi

      - name: Clean up old logs (ูุฑุฉ ููููุงู)
        if: github.event.schedule == '0 * * * *'
        run: |
          # ุชูุธูู ุงูุณุฌูุงุช ุงููุฏููุฉ (ุชุญุชูุธ ุจู 100 ุณุฌู ููุท)
          LOG_FILE="Ramadan/2025/scrape_log.json"
          if [ -f "$LOG_FILE" ]; then
            jq '.[-100:]' "$LOG_FILE" > "$LOG_FILE.tmp" && mv "$LOG_FILE.tmp" "$LOG_FILE"
            echo "๐งน ุชู ุชูุธูู ุณุฌูุงุช ุฑูุถุงู (ุจูู 100 ุณุฌู ููุท)"
            
            # ุฅุถุงูุฉ ุงูุชุบููุฑุงุช
            git add "$LOG_FILE"
            git commit -m "๐งน ุชูุธูู ุณุฌูุงุช ุฑูุถุงู - $(date +'%Y-%m-%d')" || echo "โ๏ธ ูุง ุชูุฌุฏ ุชุบููุฑุงุช"
            git push || echo "โ๏ธ ูุง ุชูุฌุฏ ุชุบููุฑุงุช ููุฑูุน"
          fi

      - name: Send notification (ุงุฎุชูุงุฑู)
        if: success()
        run: |
          echo "โ ุชู ุงุณุชุฎุฑุงุฌ ูุณูุณูุงุช ุฑูุถุงู 2025 ุจูุฌุงุญ!"
          echo "โฐ ุงูููุช: $(date)"
          echo "๐ ุงููููุน: Ramadan/2025/"
          echo "๐ฌ ุชู ุชุญุฏูุซ ุฌููุน ุงููุณูุณูุงุช"

      - name: Send error notification (ุงุฎุชูุงุฑู)
        if: failure()
        run: |
          echo "โ ูุดู ุงุณุชุฎุฑุงุฌ ูุณูุณูุงุช ุฑูุถุงู!"
          echo "โฐ ุงูููุช: $(date)"
          echo "๐ง ุงูุฑุฌุงุก ุงูุชุญูู ูู ุงูุฃุฎุทุงุก ุฃุนูุงู"
