name: Ramadan Series Scraper

on:
  workflow_dispatch:  # ุชุดุบูู ูุฏูู
  schedule:
    # ุชุดุบูู ูู ุณุงุนุฉ ูู ุงูุฏูููุฉ 0
    - cron: '0 * * * *'

jobs:
  extract-ramadan-series:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Show directory structure
        run: |
          echo "๐ ูููู ุงููููุงุช:"
          pwd
          ls -la
          echo ""
          echo "๐ ูููุงุช JavaScript:"
          find . -name "*.js" | head -10

      - name: Install dependencies
        run: |
          echo "๐ฆ ุชุซุจูุช ุงูุงุนุชูุงุฏูุงุช..."
          npm init -y --silent
          npm install jsdom
          echo "โ ุชู ุชุซุจูุช jsdom"

      - name: Create directories
        run: |
          echo "๐ ุฅูุดุงุก ุงููุฌูุฏุงุช..."
          mkdir -p Ramadan/2025
          echo "โ ุชู ุฅูุดุงุก Ramadan/2025"
          ls -la Ramadan/

      - name: Test write permissions
        run: |
          echo "โ๏ธ ุงุฎุชุจุงุฑ ุตูุงุญูุงุช ุงููุชุงุจุฉ..."
          echo "Test from GitHub Actions - $(date)" > Ramadan/2025/test.txt
          echo "โ ุชู ูุชุงุจุฉ ููู ุงุฎุชุจุงุฑู"
          ls -la Ramadan/2025/

      - name: Run Ramadan.js
        run: |
          echo "๐ ุชุดุบูู Ramadan.js..."
          echo "โฐ ุงูููุช: $(date)"
          
          if [ ! -f "Ramadan.js" ]; then
            echo "โ ERROR: ููู Ramadan.js ุบูุฑ ููุฌูุฏ!"
            echo "๐ ุงููููุงุช ุงููุชุงุญุฉ:"
            find . -name "*.js"
            exit 1
          fi
          
          echo "โ Ramadan.js ููุฌูุฏุ ุฌุงุฑู ุงูุชุดุบูู..."
          
          # ุชุดุบูู ูุน ุงูุชูุงุท ุงูุฅุฎุฑุงุฌ
          node Ramadan.js 2>&1 | tee run_output.log
          EXIT_CODE=${PIPESTATUS[0]}
          
          echo ""
          echo "๐ ููุฏ ุงูุฎุฑูุฌ: $EXIT_CODE"
          
          if [ $EXIT_CODE -ne 0 ]; then
            echo "โ Ramadan.js ูุดู ูุน ููุฏ ุฎุทุฃ: $EXIT_CODE"
            echo "๐ ุขุฎุฑ 30 ุณุทุฑ ูู ุงูุฅุฎุฑุงุฌ:"
            tail -30 run_output.log
            exit $EXIT_CODE
          fi
          
          echo "โ Ramadan.js ุงูุชูู ุจูุฌุงุญ"

      - name: Check results
        run: |
          echo "๐ ====== ุงููุชุงุฆุฌ ======"
          echo "๐ ุงูุณูุฉ: 2025"
          echo ""
          
          if [ -d "Ramadan/2025" ]; then
            echo "๐ ูุญุชููุงุช Ramadan/2025:"
            ls -lah Ramadan/2025/
            echo ""
            
            JSON_COUNT=$(find Ramadan/2025 -name "*.json" | wc -l)
            echo "๐ ุนุฏุฏ ูููุงุช JSON: $JSON_COUNT"
            
            if [ $JSON_COUNT -gt 0 ]; then
              echo ""
              echo "๐ ูููุงุช JSON ุงูููุฌูุฏุฉ:"
              find Ramadan/2025 -name "*.json" -exec basename {} \;
              
              # ุงูุชุญูู ูู ููู ุงูููุฑุณ
              if [ -f "Ramadan/2025/index_2025.json" ]; then
                echo ""
                echo "โ ููู ุงูููุฑุณ ููุฌูุฏ"
                
                # ุชุซุจูุช jq
                sudo apt-get update -q
                sudo apt-get install -y jq
                
                echo ""
                echo "๐ ูุนูููุงุช ุงูููุฑุณ:"
                jq -r '
                  "ุฅุฌูุงูู ุงููุณูุณูุงุช: \(.totalSeries // 0)",
                  "ุฅุฌูุงูู ุงูุญููุงุช: \(.totalEpisodes // 0)",
                  "ููุช ุงูุงุณุชุฎุฑุงุฌ: \(.scrapedAt // "ุบูุฑ ูุนุฑูู")"
                ' Ramadan/2025/index_2025.json
              fi
            fi
          else
            echo "โ ูุฌูุฏ Ramadan/2025 ุบูุฑ ููุฌูุฏ"
          fi
          
          echo ""
          echo "๐ ุญุฌู ุงูุฅุฎุฑุงุฌ:"
          wc -l run_output.log || echo "ูุง ููุฌุฏ ููู ุฅุฎุฑุงุฌ"

      - name: Save output log
        if: always()
        run: |
          mkdir -p logs
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          if [ -f "run_output.log" ]; then
            cp run_output.log "logs/ramadan_${TIMESTAMP}.log"
            echo "๐ ุงูุณุฌู ูุญููุธ ูู: logs/ramadan_${TIMESTAMP}.log"
          fi

      - name: Commit changes
        if: success()
        run: |
          echo "๐พ ุญูุธ ุงูุชุบููุฑุงุช..."
          
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # ุฅุถุงูุฉ ุฌููุน ุงููููุงุช ุงูุฌุฏูุฏุฉ
          git add Ramadan/ logs/ run_output.log 2>/dev/null || true
          
          if git diff --cached --quiet; then
            echo "๐ญ ูุง ุชูุฌุฏ ุชุบููุฑุงุช ุฌุฏูุฏุฉ"
          else
            echo "๐ผ ููุงู ุชุบููุฑุงุช ุฌุฏูุฏุฉ"
            git status
            
            # ุฅูุดุงุก ุฑุณุงูุฉ commit
            COMMIT_MESSAGE="๐ฌ ุชุญุฏูุซ ุฑูุถุงู 2025 - $(date +'%Y-%m-%d %H:%M')"
            
            # ุฅุถุงูุฉ ูุนูููุงุช ุฅุถุงููุฉ
            if [ -f "Ramadan/2025/index_2025.json" ] && command -v jq >/dev/null 2>&1; then
              SERIES_COUNT=$(jq -r '.totalSeries // 0' Ramadan/2025/index_2025.json 2>/dev/null || echo "?")
              EPISODES_COUNT=$(jq -r '.totalEpisodes // 0' Ramadan/2025/index_2025.json 2>/dev/null || echo "?")
              COMMIT_MESSAGE="${COMMIT_MESSAGE}
              
ุนุฏุฏ ุงููุณูุณูุงุช: ${SERIES_COUNT}
ุนุฏุฏ ุงูุญููุงุช: ${EPISODES_COUNT}"
            fi
            
            git commit -m "${COMMIT_MESSAGE}"
            git push
            echo "โ ุชู ุฑูุน ุงูุชุบููุฑุงุช"
          fi

      - name: Summary
        run: |
          echo ""
          echo "๐ ====== ููุฎุต ุงูุชุดุบูู ======"
          echo "โ ุงูุชูู ุงูุนูู ุจูุฌุงุญ"
          echo "โฐ ุงูููุช: $(date)"
          
          if [ -d "Ramadan/2025" ]; then
            echo "๐ ุงููููุน: Ramadan/2025/"
            TOTAL_FILES=$(find Ramadan/2025 -type f | wc -l)
            echo "๐ ุฅุฌูุงูู ุงููููุงุช: $TOTAL_FILES"
          fi
          
          echo "๐ ุงูุชุดุบูู ุงูุชุงูู: ุฎูุงู ุณุงุนุฉ"
