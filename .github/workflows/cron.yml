name: KiroZozo Movie Extractor

on:
  workflow_dispatch:
  schedule:
    # ูู ููู ุงูุณุงุนุฉ 6 ุตุจุงุญุงู ุจุชูููุช ุฅุณุทูุจูู (UTC+3)
    # ูุนูู 3:00 UTC
    - cron: "0 3 * * *"  # โฌ๏ธ ุบูุฑ ูู */30 * * * * ุฅูู 0 3 * * *

jobs:
  extract-movies:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: |
          npm install jsdom
          echo "โ ุชู ุชุซุจูุช ุงูุญุฒู"

      - name: Create movies directory
        run: |
          # ุฅูุดุงุก ูุฌูุฏ movies ูุณุจูุงู
          mkdir -p movies
          echo "๐ ุชู ุฅูุดุงุก ูุฌูุฏ movies"

      - name: Run the scraper
        run: |
          echo "๐ ุจุฏุก ุนูููุฉ ุงูุงุณุชุฎุฑุงุฌ ุงููููู..."
          echo "๐ ุงูููุช: $(date)"
          echo "๐ ุชูููุช ุฅุณุทูุจูู: $(TZ='Europe/Istanbul' date)"
          echo "๐ ุชุดุบูู fetch.js..."
          
          # ุชุดุบูู ุงูููู ุงูููุฌูุฏ ูู ุงูุฑูุจู
          node fetch.js
          
          echo "โ ุชู ุงูุงูุชูุงุก ูู ุงูุงุณุชุฎุฑุงุฌ"

      - name: Display results
        run: |
          echo "๐ ====== ุงููุชุงุฆุฌ ุงูููููุฉ ======"
          echo "๐ ุงูุชุงุฑูุฎ: $(date)"
          echo "๐ ุงูุชูููุช: $(TZ='Europe/Istanbul' date)"
          echo ""
          
          # ุนุฑุถ result.json
          if [ -f "result.json" ]; then
            echo "๐ฏ ููุฎุต ุงููุชุงุฆุฌ:"
            cat result.json | jq '{status, totalMoviesExtracted, lastPageProcessed, executionTime}'
            echo ""
          else
            echo "โ result.json ุบูุฑ ููุฌูุฏ"
          fi
          
          # ุนุฑุถ ูุญุชููุงุช ูุฌูุฏ movies
          echo ""
          echo "๐ ูุญุชููุงุช ูุฌูุฏ movies/:"
          if [ -d "movies" ]; then
            ls -la movies/
            echo ""
            echo "๐ ุฅุญุตุงุฆูุงุช:"
            echo "   ๐ ุนุฏุฏ ูููุงุช JSON: $(ls -1 movies/*.json 2>/dev/null | wc -l || echo '0')"
            echo "   ๐ฌ ุนุฏุฏ ุตูุญุงุช: $(ls -1 movies/*.json 2>/dev/null | grep -E '^[0-9]+\.json$' | wc -l || echo '0')"
            
            # ุนุฑุถ ุงูููุฑุณ ุฅุฐุง ูุงู ููุฌูุฏุงู
            if [ -f "movies/index.json" ]; then
              echo ""
              echo "๐ ุงูููุฑุณ:"
              cat movies/index.json | jq '{totalMovies: .stats.totalMovies, uniqueMovies: .stats.uniqueMovies, lastUpdated: .lastUpdated}'
            fi
            
            # ุนุฑุถ ุขุฎุฑ ุตูุญุฉ ูุญููุธุฉ
            echo ""
            echo "๐ ุขุฎุฑ ุตูุญุงุช ูุญููุธุฉ:"
            ls -1 movies/*.json 2>/dev/null | grep -E '^[0-9]+\.json$' | tail -5 | while read file; do
              count=$(cat "$file" | jq '.totalMovies // 0')
              echo "   $(basename "$file"): $count ูููู"
            done
            
            # ุนุฑุถ Home.json ุฅุฐุง ูุงู ููุฌูุฏุงู
            if [ -f "movies/Home.json" ]; then
              echo ""
              echo "๐ Home.json:"
              cat movies/Home.json | jq '{totalMovies, page, scrapedAt}'
            fi
          else
            echo "โ ูุฌูุฏ movies ุบูุฑ ููุฌูุฏ"
          fi

      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # ุฅุถุงูุฉ ุฌููุน ุงูุชุบููุฑุงุช
          git add result.json movies/ *.json 2>/dev/null || echo "โ๏ธ ูุง ุชูุฌุฏ ูููุงุช ุฌุฏูุฏุฉ"
          
          # ุงูุชุญูู ุฅุฐุง ูุงูุช ููุงู ุชุบููุฑุงุช
          if git diff --cached --quiet; then
            echo "๐ญ ูุง ุชูุฌุฏ ุชุบููุฑุงุช ููุฑูุน"
          else
            echo "๐ผ ุฑูุน ุงูุชุบููุฑุงุช..."
            git commit -m "๐ฌ ุชุญุฏูุซ ูููู - $(TZ='Europe/Istanbul' date +'%Y-%m-%d %H:%M')" -m "ุงุณุชุฎุฑุงุฌ ุชููุงุฆู ูู topcinema.rip"
            git push
            echo "โ ุชู ุฑูุน ุงูุชุบููุฑุงุช"
          fi
