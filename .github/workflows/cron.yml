name: ุงุณุชุฎุฑุงุฌ ุงููุงู

on:
  schedule:
    - cron: '*/15 * * * *'  # โญ ุชุบููุฑ ููุง: ูู 15 ุฏูููุฉ
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 45  # โญ ุฒูุงุฏุฉ ูููุฉ ุงูุชุดุบูู ุงููููุฉ
    
    steps:
    - name: Checkout with token
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Cache node modules
      uses: actions/cache@v3
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
    
    - name: Install dependencies
      run: |
        if [ -f "package-lock.json" ]; then
          npm ci
        else
          npm install jsdom
        fi
    
    - name: Ensure movies directory exists
      run: mkdir -p movies
    
    - name: Synchronize with remote
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # ูุญุงููุฉ sync
        git fetch origin
        git reset --hard origin/main
        git clean -fd
        
    - name: Run movie scraper
      run: |
        echo "๐ฌ ุจุฏุก ุงุณุชุฎุฑุงุฌ ุงูุฃููุงู..."
        node fetch.js --daily-update
      continue-on-error: true  # โญ ุงูุงุณุชูุฑุงุฑ ุญุชู ูู ูุดู ุงูุณูุฑูุจุช
    
    - name: Check for changes
      id: changes
      run: |
        if [[ -n $(git status --porcelain) ]]; then
          echo "โ ููุงู ุชุบููุฑุงุช ุฌุฏูุฏุฉ"
          echo "has_changes=true" >> $GITHUB_OUTPUT
        else
          echo "โญ๏ธ ูุง ุชูุฌุฏ ุชุบููุฑุงุช"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Push changes (if any)
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        # ุฅุถุงูุฉ ุงูุชุบููุฑุงุช
        git add -A
        
        # ุนูู commit
        COMMIT_MSG="๐ฌ ุชุญุฏูุซ ุงูุฃููุงู - $(date +'%Y-%m-%d %H:%M')"
        git commit -m "$COMMIT_MSG"
        
        # ูุญุงููุฉ push ูุชุนุฏุฏุฉ
        ATTEMPT=1
        MAX_ATTEMPTS=3
        
        while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
          echo "๐ ูุญุงููุฉ Push #$ATTEMPT"
          
          # ุฃููุงูุ ุณุญุจ ุฃุญุฏุซ ุงูุชุบููุฑุงุช
          if git pull --rebase origin main; then
            echo "โ ุชู ุณุญุจ ุงูุชุบููุฑุงุช ุจูุฌุงุญ"
            
            # ุงูุขู ุญุงูู push
            if git push origin main; then
              echo "๐ ุชู ุฑูุน ุงูุชุบููุฑุงุช ุจูุฌุงุญ!"
              break
            else
              echo "โ ูุดู Push #$ATTEMPT"
            fi
          else
            echo "โ ูุดู pull ูู ุงููุญุงููุฉ #$ATTEMPT"
          fi
          
          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "๐ฅ ูุดูุช ุฌููุน ุงููุญุงููุงุช"
            exit 1
          fi
          
          ATTEMPT=$((ATTEMPT + 1))
          echo "โณ ุงูุชุธุงุฑ 10 ุซูุงูู ูุจู ุงููุญุงููุฉ ุงูุชุงููุฉ..."
          sleep 10
        done
