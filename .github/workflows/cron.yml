name: KiroZozo Movie Extractor

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"  # ÙƒÙ„ 30 Ø¯Ù‚ÙŠÙ‚Ø©

jobs:
  extract-movies:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: |
          npm init -y
          npm install jsdom
          echo "âœ… ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„Ø­Ø²Ù…"

      - name: Create and run fetch script
        run: |
          echo "ğŸš€ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬..."
          echo "ğŸ“… Ø§Ù„ÙˆÙ‚Øª: $(date)"
          
          # Ø¥Ù†Ø´Ø§Ø¡ fetch.js Ù…Ø¨Ø§Ø´Ø±Ø©
          cat > fetch.js << 'EOF'
          import fs from "fs";
          import { JSDOM } from "jsdom";

          // Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø£ÙÙ„Ø§Ù…
          async function fetchMovies() {
              console.log("ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙÙ„Ø§Ù…...");
              
              try {
                  // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
                  const response = await fetch("https://topcinema.media/movies/");
                  if (!response.ok) throw new Error("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„");
                  
                  const html = await response.text();
                  const dom = new JSDOM(html);
                  const movies = [];
                  
                  // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                  const elements = dom.window.document.querySelectorAll('.Small--Box');
                  elements.forEach((el, i) => {
                      if (i >= 5) return;
                      const title = el.querySelector('.title')?.textContent || `ÙÙŠÙ„Ù… ${i+1}`;
                      movies.push({
                          title: title,
                          url: `https://topcinema.media/movie-${i}`,
                          quality: "HD",
                          rating: (7 + Math.random() * 2).toFixed(1)
                      });
                  });
                  
                  return movies.length > 0 ? movies : getSampleMovies();
                  
              } catch (error) {
                  console.log("âš ï¸ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©");
                  return getSampleMovies();
              }
          }

          function getSampleMovies() {
              return [
                  { title: "ÙÙŠÙ„Ù… Ø§Ù„Ù…ØºØ§Ù…Ø±Ø©", quality: "HD 1080p", rating: "8.2" },
                  { title: "Ø§Ù„ÙƒÙˆÙ…ÙŠØ¯ÙŠØ§ Ø§Ù„Ø±Ø§Ø¦Ø¹Ø©", quality: "FHD", rating: "7.5" },
                  { title: "Ø§Ù„Ø±Ø¹Ø¨ Ø§Ù„Ù…Ø®ÙŠÙ", quality: "4K", rating: "6.8" },
                  { title: "Ø§Ù„Ø¯Ø±Ø§Ù…Ø§ Ø§Ù„Ø¹Ø§Ø·ÙÙŠØ©", quality: "HD", rating: "9.1" },
                  { title: "Ø§Ù„Ø®ÙŠØ§Ù„ Ø§Ù„Ø¹Ù„Ù…ÙŠ", quality: "HD 720p", rating: "8.7" }
              ];
          }

          async function main() {
              console.log("ğŸ¬ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬...");
              const movies = await fetchMovies();
              
              const result = {
                  success: true,
                  timestamp: new Date().toISOString(),
                  movies: movies,
                  count: movies.length,
                  note: movies[0].title.includes("Ø§Ù„Ù…ØºØ§Ù…Ø±Ø©") ? "Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©" : "Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ©"
              };
              
              fs.writeFileSync("result.json", JSON.stringify(result, null, 2));
              console.log("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙÙŠ result.json");
              console.log("ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙÙ„Ø§Ù…:", movies.length);
          }

          main();
          EOF
          
          # ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù„Ù
          node fetch.js

      - name: Show results
        run: |
          echo "ğŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬:"
          if [ -f "result.json" ]; then
            echo "âœ… result.json Ù…ÙˆØ¬ÙˆØ¯"
            echo "ğŸ¬ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙÙ„Ø§Ù…: $(grep -c '"title"' result.json || echo '0')"
            echo "ğŸ“ Ø§Ù„Ù…Ø­ØªÙˆÙ‰:"
            cat result.json | jq '.movies[0:2]'
          else
            echo "âŒ Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ result.json"
          fi

      - name: Commit changes
        run: |
          git config user.name "KiroZozo Bot"
          git config user.email "bot@kirozozo.com"
          git add .
          git commit -m "ğŸ¬ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙÙ„Ø§Ù… $(date +'%H:%M')" || echo "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª"
          git push || echo "Ù„Ø§ Ø´ÙŠØ¡ Ù„Ù„Ø±ÙØ¹"
