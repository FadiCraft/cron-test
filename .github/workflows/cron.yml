name: KiroZozo Movie Extractor

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"  # ÙƒÙ„ 30 Ø¯Ù‚ÙŠÙ‚Ø©

jobs:
  extract-movies:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: |
          npm install jsdom
          echo "âœ… ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„Ø­Ø²Ù…"

      - name: Create movies directory
        run: |
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ movies Ù…Ø³Ø¨Ù‚Ø§Ù‹
          mkdir -p movies
          echo "ğŸ“ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ movies"

      - name: Run the scraper
        run: |
          echo "ğŸš€ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬..."
          echo "ğŸ“… Ø§Ù„ÙˆÙ‚Øª: $(date)"
          echo "ğŸ”„ ØªØ´ØºÙŠÙ„ fetch.js..."
          
          # ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø±ÙŠØ¨Ùˆ
          node fetch.js
          
          echo "âœ… ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬"

      - name: Display results
        run: |
          echo "ğŸ“Š ====== Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ======"
          
          # Ø¹Ø±Ø¶ result.json
          if [ -f "result.json" ]; then
            echo "ğŸ¯ Ù…Ù„Ù result.json:"
            cat result.json
            echo ""
          else
            echo "âŒ result.json ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"
          fi
          
          # Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙŠØ§Øª Ù…Ø¬Ù„Ø¯ movies
          echo ""
          echo "ğŸ“‚ Ù…Ø­ØªÙˆÙŠØ§Øª Ù…Ø¬Ù„Ø¯ movies:"
          if [ -d "movies" ]; then
            ls -la movies/
            echo ""
            echo "ğŸ¬ Ø¹Ø¯Ø¯ Ù…Ù„ÙØ§Øª Ø§Ù„Ø£ÙÙ„Ø§Ù…: $(ls -1 movies/*.json 2>/dev/null | wc -l || echo '0')"
            
            # Ø¹Ø±Ø¶ Ø§Ù„ÙÙ‡Ø±Ø³ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            if [ -f "movies/index.json" ]; then
              echo ""
              echo "ğŸ“‹ Ø§Ù„ÙÙ‡Ø±Ø³:"
              cat movies/index.json | jq '{totalMovies: .totalMovies, scrapedMovies: .scrapedMovies, lastUpdated: .lastUpdated}'
            fi
            
            # Ø¹Ø±Ø¶ Ù…Ø«Ø§Ù„ Ù…Ù† Ù…Ù„Ù ÙÙŠÙ„Ù…
            if ls movies/movie_*.json 1> /dev/null 2>&1; then
              echo ""
              echo "ğŸ¥ Ù…Ø«Ø§Ù„ Ù…Ù† Ù…Ù„Ù ÙÙŠÙ„Ù…:"
              first_movie=$(ls movies/movie_*.json | head -1)
              echo "ğŸ”¸ Ø§Ù„Ù…Ù„Ù: $(basename $first_movie)"
              cat $first_movie | jq '{id: .id, title: .title, imdbRating: .imdbRating}'
            fi
          else
            echo "âŒ Ù…Ø¬Ù„Ø¯ movies ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"
          fi

      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # Ø¥Ø¶Ø§ÙØ© Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
          git add result.json movies/ || echo "âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ø¬Ø¯ÙŠØ¯Ø©"
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ ØªØºÙŠÙŠØ±Ø§Øª
          if git diff --cached --quiet; then
            echo "ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ù„Ù„Ø±ÙØ¹"
          else
            echo "ğŸ”¼ Ø±ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª..."
            git commit -m "ğŸ¬ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙÙ„Ø§Ù… - $(date +'%Y-%m-%d %H:%M')" -m "ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£ÙÙ„Ø§Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹"
            git push
            echo "âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª"
          fi
