name: KiroZozo Movie Fetcher

on:
  workflow_dispatch:  # Ù„Ù„ØªÙ†ÙÙŠØ° Ø§Ù„ÙŠØ¯ÙˆÙŠ
  schedule:
    - cron: "0 */2 * * *"  # ÙƒÙ„ Ø³Ø§Ø¹ØªÙŠÙ†
    - cron: "0 12 * * *"    # ÙŠÙˆÙ…ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø© 12 Ø¸Ù‡Ø±Ø§Ù‹

jobs:
  fetch-movies:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          # Ø¥Ù†Ø´Ø§Ø¡ package.json Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
          if [ ! -f "package.json" ]; then
            echo '{
              "name": "kirozozo-cron",
              "version": "1.0.0",
              "type": "module",
              "dependencies": {
                "node-fetch": "^3.3.1",
                "jsdom": "^22.1.0"
              }
            }' > package.json
          fi
          
          # ØªØ«Ø¨ÙŠØª Ø§Ù„Ø­Ø²Ù…
          npm install
          
          # Ø¥Ù†Ø´Ø§Ø¡ package-lock.json
          npm init -y --silent

      - name: Run movie fetcher
        run: node fetch.js
        timeout-minutes: 10

      - name: Show results
        run: |
          echo "=== Extracted Data ==="
          if [ -f "result.json" ]; then
            cat result.json | jq '.stats'
          else
            echo "No result.json found"
          fi

      - name: Commit and push changes
        run: |
          git config --local user.name "GitHub Action"
          git config --local user.email "action@github.com"
          git add .
          git diff --quiet && git diff --staged --quiet || git commit -m "ðŸ”´ Updated movie data - $(date +'%Y-%m-%d %H:%M')"
          git push
