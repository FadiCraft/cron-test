name: KiroZozo Movie Extractor

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"  # ูู 30 ุฏูููุฉ

jobs:
  extract-movies:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: |
          npm install jsdom
          echo "โ ุชู ุชุซุจูุช ุงูุญุฒู"

      - name: Create directories
        run: |
          mkdir -p pages movies
          echo "๐ ุชู ุฅูุดุงุก ุงููุฌูุฏุงุช"

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git pull origin main

      - name: Run incremental scraper
        run: |
          echo "๐ ุจุฏุก ุงูุงุณุชุฎุฑุงุฌ ุฃูู ุจุฃูู..."
          echo "๐ ุงูููุช: $(date)"
          
          # ุชุดุบูู ุงูููู ุงูููุฌูุฏ
          node fetch.js
          
          echo "โ ุชู ุงูุงูุชูุงุก ูู ุงูุชูููุฐ"

      - name: Display incremental results
        run: |
          echo "๐ ====== ุงููุชุงุฆุฌ ุฃูู ุจุฃูู ======"
          
          if [ -f "progress.json" ]; then
            echo "๐ ุญุงูุฉ ุงูุชูุฏู:"
            cat progress.json
            echo ""
          fi
          
          if [ -f "result.json" ]; then
            echo "๐ฏ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ:"
            cat result.json
            echo ""
          fi
          
          echo "๐ ูุญุชููุงุช ุงููุฌูุฏุงุช:"
          echo "pages/: $(ls -1 pages/ 2>/dev/null | wc -l || echo '0') ููู"
          echo "movies/: $(ls -1 movies/ 2>/dev/null | wc -l || echo '0') ููู"

      - name: Auto-commit and push incremental changes
        run: |
          echo "๐ ุฌุงุฑู ุงูุงูุชุฒุงู ุจุงูุชุบููุฑุงุช..."
          
          # ุฅุถุงูุฉ ุฌููุน ุงููููุงุช ุงูุฌุฏูุฏุฉ
          git add pages/ movies/ result.json progress.json last_page.json || echo "โ๏ธ ูุง ุชูุฌุฏ ูููุงุช ุฌุฏูุฏุฉ"
          
          # ุงูุชุญูู ูู ุงูุชุบููุฑุงุช
          if git diff --cached --quiet; then
            echo "๐ญ ูุง ุชูุฌุฏ ุชุบููุฑุงุช ููุฑูุน"
          else
            echo "๐ผ ุฑูุน ุงูุชุบููุฑุงุช ุฃูู ุจุฃูู..."
            
            # ุฑุณุงูุฉ ุงูุงูุชุฒุงู
            if [ -f "progress.json" ]; then
              LAST_PAGE=$(cat progress.json | jq -r '.currentPage // 0')
              TOTAL_MOVIES=$(cat progress.json | jq -r '.totalNewMovies // 0')
              COMMIT_MSG="๐ฌ ุชุญุฏูุซ ุชููุงุฆู - ุงูุตูุญุฉ $((LAST_PAGE - 1)) - $TOTAL_MOVIES ุฃููุงู ุฌุฏูุฏุฉ"
            else
              COMMIT_MSG="๐ฌ ุชุญุฏูุซ ุชููุงุฆู - $(date +'%Y-%m-%d %H:%M')"
            fi
            
            git commit -m "$COMMIT_MSG" -m "ุงุณุชุฎุฑุงุฌ ุฃูู ุจุฃูู ูู topcinema.rip"
            git push origin main
            echo "โ ุชู ุฑูุน ุงูุชุบููุฑุงุช"
          fi
