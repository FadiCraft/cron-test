name: KiroZozo Movie Extractor v2

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"  # ÙƒÙ„ 30 Ø¯Ù‚ÙŠÙ‚Ø©

jobs:
  extract-movies:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install jsdom
        run: |
          npm init -y --silent
          npm install jsdom
          echo "âœ… ØªÙ… ØªØ«Ø¨ÙŠØª jsdom"

      - name: Run the movie extractor
        run: |
          echo "ğŸš€ Ø¨Ø¯Ø¡ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£ÙÙ„Ø§Ù…..."
          echo "â° Ø§Ù„ÙˆÙ‚Øª: $(date)"
          echo ""
          
          # Ø¥Ù†Ø´Ø§Ø¡ fetch.js
          cat > fetch.js << 'EOF'
          // Ø¶Ø¹ Ù…Ø­ØªÙˆÙ‰ fetch.js Ø§Ù„ÙƒØ§Ù…Ù„ Ø£Ø¹Ù„Ø§Ù‡ Ù‡Ù†Ø§
          // Ø£Ùˆ Ø£Ø­ÙØ¸Ù‡ ÙÙŠ Ù…Ù„Ù Ù…Ù†ÙØµÙ„ ÙˆØ£Ø´ÙŠØ± Ø¥Ù„ÙŠÙ‡
          EOF
          
          # Ù†Ø³Ø® Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ (Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ù…Ù„Ù Ù…Ù†ÙØµÙ„)
          curl -s https://raw.githubusercontent.com/username/repo/main/fetch.js > fetch.js 2>/dev/null || echo "Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø¯Ù…Ø¬"
          
          # ØªØ´ØºÙŠÙ„
          node fetch.js
          
          echo ""
          echo "ğŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬:"
          ls -la *.json *.html

      - name: Show statistics
        run: |
          echo "ğŸ“ˆ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬:"
          if [ -f "result.json" ]; then
            TOTAL=$(grep -o '"totalMovies":[0-9]*' result.json | grep -o '[0-9]*' | head -1)
            NEW=$(grep -o '"newMoviesAdded":[0-9]*' result.json | grep -o '[0-9]*' | head -1)
            echo "âœ… Ø§Ù„Ø£ÙÙ„Ø§Ù… Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: ${TOTAL:-0}"
            echo "ğŸ†• Ø§Ù„Ø£ÙÙ„Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: ${NEW:-0}"
            echo ""
            echo "ğŸ¬ Ø£ÙˆÙ„ 3 Ø£ÙÙ„Ø§Ù…:"
            grep -o '"title":"[^"]*"' result.json | head -3 | sed 's/"title":"//g' | sed 's/"/ /g' | nl
          else
            echo "âŒ Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ result.json"
          fi

      - name: Commit and push updates
        if: success()
        run: |
          git config user.name "KiroZozo Bot"
          git config user.email "bot@kirozozo.com"
          
          # Ø£Ø¶Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
          git add result.json report.html movies_simple.json movies_cache.json 2>/dev/null || true
          
          # ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØºÙŠÙŠØ±Ø§Øª
          if git diff --quiet --cached; then
            echo "ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©"
          else
            # Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙÙ„Ø§Ù…
            COUNT=$(grep -o '"totalMovies":[0-9]*' result.json 2>/dev/null | grep -o '[0-9]*' | head -1 || echo "0")
            git commit -m "ğŸ¬ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙÙ„Ø§Ù… (${COUNT} ÙÙŠÙ„Ù…) - $(date +'%H:%M')"
            git push
            echo "âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª"
          fi
