name: KiroZozo Extractor with Monitoring

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"  # ูู 15 ุฏูููุฉ

jobs:
  extract-and-monitor:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ุฌูุจ ุงูููุฏ
      - uses: actions/checkout@v3
      
      # 2. ุฅุนุฏุงุฏ Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      # 3. ุฅูุดุงุก ููู ุงูุงุณุชุฎุฑุงุฌ
      - name: Create extraction script
        run: |
          echo "๐ ุฅูุดุงุก ููู fetch.js..."
          cat > fetch.js << 'EOF'
          // ุงูููุฏ ุงูุฐู ูุถุนุชู ุฃุนูุงู
          EOF
      
      # 4. ุชุดุบูู ุงูุงุณุชุฎุฑุงุฌ ูุน ุงูุชุณุฌูู
      - name: Run extraction
        run: |
          echo "๐ ุจุฏุก ุงูุงุณุชุฎุฑุงุฌ..."
          echo "โฐ ุงูููุช ุงูุญุงูู: $(date)"
          echo "๐ ุงููููุงุช ูุจู ุงูุชุดุบูู:"
          ls -la *.json *.html *.txt 2>/dev/null || echo "ูุง ุชูุฌุฏ ูููุงุช ุณุงุจูุฉ"
          echo ""
          
          # ุชุดุบูู fetch.js ูุน ุชุณุฌูู ุงููุฎุฑุฌุงุช
          node fetch.js 2>&1 | tee extraction_output.log
          
          echo ""
          echo "โ ุงูุชูู ุงูุงุณุชุฎุฑุงุฌ!"
          echo "๐ ุงููููุงุช ุจุนุฏ ุงูุชุดุบูู:"
          ls -la *.json *.html *.txt
      
      # 5. ุชุญููู ุงููุชุงุฆุฌ
      - name: Analyze results
        run: |
          echo "๐ ุชุญููู ุงููุชุงุฆุฌ:"
          echo "================="
          
          if [ -f "extraction_output.log" ]; then
            echo "๐ ุขุฎุฑ 10 ุฃุณุทุฑ ูู ุงูุณุฌู:"
            tail -20 extraction_output.log
          fi
          
          if [ -f "result.json" ]; then
            echo ""
            echo "๐ฌ ูุนูููุงุช ุงูุฃููุงู:"
            MOVIE_COUNT=$(grep -o '"title"' result.json | wc -l)
            echo "   ุนุฏุฏ ุงูุฃููุงู: $MOVIE_COUNT"
            
            echo ""
            echo "๐ ุนูุงููู ุงูุฃููุงู:"
            grep -o '"title":"[^"]*"' result.json | head -10 | sed 's/"title":"//g' | sed 's/"//g' | nl
          else
            echo "โ ูู ูุชู ุฅูุดุงุก result.json"
          fi
      
      # 6. ุญูุธ ุงููุชุงุฆุฌ ูู Artifacts (ูุชุญููููุง)
      - name: Save artifacts
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: extraction-results
          path: |
            result.json
            report.html
            extraction_output.log
          retention-days: 7
      
      # 7. ุฅุธูุงุฑ ููุฎุต
      - name: Show summary
        run: |
          echo "๐ฏ ููุฎุต ุงูุชูููุฐ:"
          echo "================="
          echo "โ ุชู ุงูุงูุชูุงุก: $(date)"
          echo "๐ ููููู ุชูุฒูู ุงููุชุงุฆุฌ ูู ุชุจููุจ 'Artifacts'"
          echo "๐ ููุชูุงุตูู ุงููุงููุฉ:"
          echo "   1. ุงููุฑ ุนูู ุงุณู Workflow ูุฐุง"
          echo "   2. ุงููุฑ ุนูู 'extract-and-monitor'"
          echo "   3. ุดุงูุฏ ุฌููุน ุงูุฎุทูุงุช ูุงููุชุงุฆุฌ"
      
      # 8. ุฑูุน ุงููุชุงุฆุฌ ุฅูู GitHub
      - name: Commit and push
        run: |
          git config user.name "KiroZozo Bot"
          git config user.email "bot@kirozozo.com"
          git add .
          git commit -m "๐ด ุชุญุฏูุซ ุงูุฃููุงู $(date +'%H:%M')" || echo "ูุง ุชูุฌุฏ ุชุบููุฑุงุช"
          git push || echo "ูุง ุดูุก ููุฑูุน"
