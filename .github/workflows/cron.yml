name: KiroZozo Movie Extractor

on:
  workflow_dispatch:
    inputs:
      script:
        description: 'Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ù Ù„ØªØ´ØºÙŠÙ„Ù‡'
        required: false
        default: 'both'
        type: choice
        options:
        - fetch.js
        - fetch_daily.js
        - both
  
  # Ø¬Ø¯ÙˆÙ„Ø© ØµØ­ÙŠØ­Ø©
  schedule:
    - cron: "*/30 * * * *"    # ÙƒÙ„ 30 Ø¯Ù‚ÙŠÙ‚Ø©
    - cron: "0 */6 * * *"     # ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª

jobs:
  extract-movies:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4  # ØªØ­Ø¯ÙŠØ« Ø¥Ù„Ù‰ v4

      - name: Setup Node.js
        uses: actions/setup-node@v4  # ØªØ­Ø¯ÙŠØ« Ø¥Ù„Ù‰ v4
        with:
          node-version: '20'  # ØªØ­Ø¯ÙŠØ« Ø¥Ù„Ù‰ Node.js 20

      - name: Install dependencies
        run: |
          npm install jsdom
          echo "âœ… ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„Ø­Ø²Ù…"

      - name: Determine which script to run
        id: script-selector
        run: |
          SCRIPT_TO_RUN=""
          
          # Ø¥Ø°Ø§ ÙƒØ§Ù† ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠØŒ Ø§Ø³ØªØ®Ø¯Ù… input
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            SCRIPT_TO_RUN="${{ github.event.inputs.script }}"
            echo "ğŸ”§ ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠ: $SCRIPT_TO_RUN"
          
          # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¬Ø¯ÙˆÙ„Ø© (schedule)ØŒ Ù†Ø­Ø¯Ø¯ Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª
          elif [ "${{ github.event_name }}" == "schedule" ]; then
            CURRENT_HOUR=$(date +%H)
            CURRENT_MINUTE=$(date +%M)
            
            # Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ 00, 30 (ÙƒÙ„ 30 Ø¯Ù‚ÙŠÙ‚Ø©) - ØªØ´ØºÙŠÙ„ fetch.js
            if [ $CURRENT_MINUTE -eq 0 ] || [ $CURRENT_MINUTE -eq 30 ]; then
              SCRIPT_TO_RUN="fetch.js"
              echo "ğŸ”§ Ø¬Ø¯ÙˆÙ„Ø© (ÙƒÙ„ 30 Ø¯Ù‚ÙŠÙ‚Ø©): $SCRIPT_TO_RUN"
            
            # Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø³Ø§Ø¹Ø© 0, 6, 12, 18 (ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª) - ØªØ´ØºÙŠÙ„ fetch_daily.js
            elif [ $CURRENT_HOUR -eq 0 ] || [ $CURRENT_HOUR -eq 6 ] || [ $CURRENT_HOUR -eq 12 ] || [ $CURRENT_HOUR -eq 18 ]; then
              SCRIPT_TO_RUN="fetch_daily.js"
              echo "ğŸ”§ Ø¬Ø¯ÙˆÙ„Ø© (ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª): $SCRIPT_TO_RUN"
            else
              echo "âš ï¸  Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¬Ø¯ÙˆÙ„Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙˆÙ‚Øª"
              exit 0  # Ø®Ø±ÙˆØ¬ Ù†Ø¸ÙŠÙ Ø¨Ø¯ÙˆÙ† Ø®Ø·Ø£
            fi
          fi
          
          if [ -n "$SCRIPT_TO_RUN" ]; then
            echo "script=$SCRIPT_TO_RUN" >> $GITHUB_OUTPUT
          fi

      - name: Run the selected script
        run: |
          if [ -z "${{ steps.script-selector.outputs.script }}" ]; then
            echo "âŒ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…Ù„Ù Ù„Ù„ØªØ´ØºÙŠÙ„"
            exit 0
          fi
          
          echo "ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„..."
          echo "ğŸ“… Ø§Ù„ÙˆÙ‚Øª: $(date)"
          echo "ğŸ“ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­Ø¯Ø¯: ${{ steps.script-selector.outputs.script }}"
          
          # ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù„Ù/Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
          case "${{ steps.script-selector.outputs.script }}" in
            "fetch.js")
              echo "ğŸ”„ ØªØ´ØºÙŠÙ„ fetch.js..."
              if [ -f "fetch.js" ]; then
                node fetch.js
              else
                echo "âŒ Ù…Ù„Ù fetch.js ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!"
                exit 1
              fi
              ;;
            "fetch_daily.js")
              echo "ğŸ”„ ØªØ´ØºÙŠÙ„ fetch_daily.js..."
              if [ -f "fetch_daily.js" ]; then
                node fetch_daily.js
              else
                echo "âŒ Ù…Ù„Ù fetch_daily.js ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!"
                exit 1
              fi
              ;;
            "both")
              echo "ğŸ”„ ØªØ´ØºÙŠÙ„ fetch.js Ø£ÙˆÙ„Ø§Ù‹..."
              if [ -f "fetch.js" ]; then
                node fetch.js
              else
                echo "âŒ Ù…Ù„Ù fetch.js ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!"
                exit 1
              fi
              
              echo "â³ Ø§Ù†ØªØ¸Ø§Ø± 10 Ø«ÙˆØ§Ù†ÙŠ..."
              sleep 10
              
              echo "ğŸ”„ ØªØ´ØºÙŠÙ„ fetch_daily.js Ø«Ø§Ù†ÙŠØ§Ù‹..."
              if [ -f "fetch_daily.js" ]; then
                node fetch_daily.js
              else
                echo "âŒ Ù…Ù„Ù fetch_daily.js ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!"
                exit 1
              fi
              ;;
            *)
              echo "âŒ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…Ù„Ù ØµØ§Ù„Ø­"
              exit 1
              ;;
          esac
          
          echo "âœ… ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ´ØºÙŠÙ„"
