name: KiroZozo Movie Extractor

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"  # ÙƒÙ„ 30 Ø¯Ù‚ÙŠÙ‚Ø©

jobs:
  extract-movies:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm init -y
          npm install node-fetch jsdom

      - name: Create and run fetch script
        run: |
          # Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
          rm -f fetch.js result.json report.html
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯
          cat > fetch.js << 'EOF'
          // Ø¶Ø¹ Ù…Ø­ØªÙˆÙ‰ fetch.js Ø§Ù„ÙƒØ§Ù…Ù„ Ù‡Ù†Ø§...
          EOF
          
          # Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙØ¹Ù„ÙŠ
          # (Ø³Ù†Ù‚ÙˆÙ… Ø¨Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ Ø£Ø¹Ù„Ø§Ù‡ Ù‡Ù†Ø§)
          
          # ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù„Ù
          node fetch.js

      - name: Show extraction summary
        run: |
          echo "ðŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬:"
          if [ -f "result.json" ]; then
            echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ result.json"
            echo "ðŸ“ˆ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙÙ„Ø§Ù…: $(cat result.json | grep -o '"totalMovies":[0-9]*' | grep -o '[0-9]*')"
            echo "ðŸ•’ Ø§Ù„ÙˆÙ‚Øª: $(cat result.json | grep -o '"timestamp":"[^"]*"' | head -1 | cut -d'"' -f4)"
          else
            echo "âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ result.json"
          fi
          
          if [ -f "report.html" ]; then
            echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ report.html"
          fi

      - name: Commit and push results
        run: |
          git config --local user.name "KiroZozo Bot"
          git config --local user.email "bot@kirozozo.com"
          git add .
          git diff --quiet && git diff --staged --quiet || git commit -m "ðŸŽ¬ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙÙ„Ø§Ù… - $(date +'%Y-%m-%d %H:%M')"
          git push
