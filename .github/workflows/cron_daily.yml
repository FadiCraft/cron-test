name: KiroZozo Daily Movie Extractor

on:
  workflow_dispatch:
  schedule:
    # ุชุดุบูู ูู ููู ุนูุฏ ุงูุณุงุนุฉ 2 ุตุจุงุญุงู UTC
    - cron: "0 2 * * *"  # ูู ููู ูู ุงูุณุงุนุฉ 2 ุตุจุงุญุงู

jobs:
  extract-daily:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: |
          npm install jsdom
          echo "โ ุชู ุชุซุจูุช ุงูุญุฒู"

      - name: Create movies directory
        run: |
          # ุฅูุดุงุก ูุฌูุฏ movies ูุณุจูุงู
          mkdir -p movies
          echo "๐ ุชู ุฅูุดุงุก ูุฌูุฏ movies"

      - name: Run fetch_daily.js
        run: |
          echo "๐ ุจุฏุก ุนูููุฉ ุงูุงุณุชุฎุฑุงุฌ ุงููููู..."
          echo "๐ ุงูููุช: $(date)"
          echo "๐ ุงูุฌุฏููุฉ: ูู ููู ูู ุงูุณุงุนุฉ 2 ุตุจุงุญุงู UTC"
          echo "๐ ุงูููู: fetch_daily.js"
          echo "๐ ุฌุงุฑู ุงูุชุดุบูู..."
          
          # ุชุดุบูู ููู fetch_daily.js
          if [ -f "fetch_daily.js" ]; then
            node fetch_daily.js
            echo "โ ุชู ุชุดุบูู fetch_daily.js ุจูุฌุงุญ"
          else
            echo "โ ููู fetch_daily.js ุบูุฑ ููุฌูุฏ!"
            echo "๐ ุงููููุงุช ุงูููุฌูุฏุฉ:"
            ls -la *.js || echo "ูุง ุชูุฌุฏ ูููุงุช js"
            exit 1
          fi
          
          echo "โ ุชู ุงูุงูุชูุงุก ูู ุงูุงุณุชุฎุฑุงุฌ ุงููููู"

      - name: Check results
        run: |
          echo "๐ ====== ุงููุชุงุฆุฌ ุงูููููุฉ ======"
          echo "โฐ ููุช ุงูุชุดุบูู: $(date)"
          
          # ุงูุชุญูู ูู ูุฌูุฏ ููู Hg.json
          if [ -f "movies/Hg.json" ]; then
            echo "โ ุชู ุฅูุดุงุก ููู movies/Hg.json"
            echo "๐ ุญุฌู ุงูููู: $(wc -c < movies/Hg.json) ุจุงูุช"
            
            # ุนุฑุถ ูุนูููุงุช ุนู ุงูููู
            echo ""
            echo "๐ ูุนูููุงุช ุงูููู:"
            echo '{
              "ููู": "movies/Hg.json",
              "ููุช_ุงูุชุดุบูู": "'$(date)'",
              "ุงูุญุงูุฉ": "โ ุฌุงูุฒ"
            }' | jq .
            
            # ุนุฑุถ ุฃูู 3 ุฃููุงู
            echo ""
            echo "๐ฅ ุฃูู 3 ุฃููุงู ูุณุชุฎุฑุฌุฉ:"
            if command -v jq &> /dev/null; then
              jq '.movies[0:3]' movies/Hg.json
            else
              echo "โ jq ุบูุฑ ูุซุจุชุ ุชุซุจูุชู..."
              sudo apt-get install -y jq
              jq '.movies[0:3]' movies/Hg.json
            fi
            
          else
            echo "โ ูู ูุชู ุฅูุดุงุก movies/Hg.json"
            echo "๐ ูุญุชููุงุช ูุฌูุฏ movies:"
            if [ -d "movies" ]; then
              ls -la movies/
            else
              echo "โ ูุฌูุฏ movies ุบูุฑ ููุฌูุฏ"
            fi
          fi

      - name: Commit and push daily changes
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # ุฅุถุงูุฉ ุงูุชุบููุฑุงุช ุงูููููุฉ
          git add movies/Hg.json || echo "โ๏ธ ูุง ููุฌุฏ Hg.json ุฌุฏูุฏ"
          
          # ุงูุชุญูู ุฅุฐุง ูุงูุช ููุงู ุชุบููุฑุงุช
          if git diff --cached --quiet; then
            echo "๐ญ ูุง ุชูุฌุฏ ุชุบููุฑุงุช ุฌุฏูุฏุฉ ููุฑูุน"
          else
            echo "๐ผ ุฑูุน ุงูุชุบููุฑุงุช ุงูููููุฉ..."
            git commit -m "๐ฌ ุชุญุฏูุซ ุงูุฃููุงู ุงููููู - $(date +'%Y-%m-%d')" -m "ุชู ุงุณุชุฎุฑุงุฌ ุงูุฃููุงู ุงููููู ุชููุงุฆูุงู - $(date +'%H:%M')"
            git push
            echo "โ ุชู ุฑูุน ุงูุชุบููุฑุงุช ุงูููููุฉ"
          fi
