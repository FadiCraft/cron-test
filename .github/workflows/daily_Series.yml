name: KiroZozo Series Extractor

on:
  workflow_dispatch:
  schedule:
    # ุชุดุบูู ููููุงู ุนูุฏ ุงูุณุงุนุฉ 2 ุตุจุงุญุงู (ููููู ุชุบููุฑ ุงูุณุงุนุฉ)
    - cron: "0 2 * * *"  # ููููุงู ูู ุงูุณุงุนุฉ 2 ุตุจุงุญุงู

jobs:
  extract-series:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: |
          npm install jsdom
          echo "โ ุชู ุชุซุจูุช ุงูุญุฒู"

      - name: Create series directories
        run: |
          # ุฅูุดุงุก ูุฌูุฏุงุช Series ูุงููุฌูุฏุงุช ุงููุฑุนูุฉ
          mkdir -p Series/Series
          mkdir -p Series/Seasons
          mkdir -p Series/Episodes
          echo "๐ ุชู ุฅูุดุงุก ูุฌูุฏุงุช Series:"
          echo "  - Series/Series"
          echo "  - Series/Seasons"
          echo "  - Series/Episodes"

      - name: Run the series scraper
        run: |
          echo "๐ ุจุฏุก ุนูููุฉ ุงุณุชุฎุฑุงุฌ ุงููุณูุณูุงุช..."
          echo "๐ ุงูููุช: $(date)"
          echo "๐ ุงูุฌุฏููุฉ: ููููุงู"
          echo "๐ ุชุดุบูู daily_Series.js..."
          
          # ุชุดุบูู ุงูููู ุงูููุฌูุฏ ูู ุงูุฑูุจู
          node daily_Series.js
          
          echo "โ ุชู ุงูุงูุชูุงุก ูู ุงุณุชุฎุฑุงุฌ ุงููุณูุณูุงุช"

      - name: Display results
        run: |
          echo "๐ ====== ุงููุชุงุฆุฌ ======"
          
          # ุนุฑุถ error.json ุฅุฐุง ูุงู ููุฌูุฏุงู
          if [ -f "Series/error.json" ]; then
            echo "โ๏ธ  ููู error.json ููุฌูุฏ:"
            cat Series/error.json | jq '.error'
            echo ""
          fi
          
          # ุนุฑุถ ูุญุชููุงุช ูุฌูุฏ Series/Series
          echo ""
          echo "๐ ูุญุชููุงุช ูุฌูุฏ Series/Series:"
          if [ -d "Series/Series" ]; then
            ls -la Series/Series/
            
            # ุนุฑุถ Hg.json ุฅุฐุง ูุงู ููุฌูุฏุงู
            if [ -f "Series/Series/Hg.json" ]; then
              echo ""
              echo "๐ ููู Hg.json:"
              cat Series/Series/Hg.json | jq '{totalSeries: .totalSeries, scrapedAt: .scrapedAt, lastUpdated: .lastUpdated}'
              
              # ุนุฑุถ ูุซุงู ูู ูุณูุณู
              echo ""
              echo "๐บ ูุซุงู ูู ุงููุณูุณูุงุช:"
              cat Series/Series/Hg.json | jq '.series[0] | {id: .id, title: .title, seasonsCount: .seasonsCount, imdbRating: .imdbRating}'
            fi
          else
            echo "โ ูุฌูุฏ Series/Series ุบูุฑ ููุฌูุฏ"
          fi

      - name: Display seasons statistics
        run: |
          echo ""
          echo "๐ ุฅุญุตุงุฆูุงุช ุงูููุงุณู:"
          if [ -d "Series/Seasons" ]; then
            echo "๐ ุนุฏุฏ ูููุงุช ุงูููุงุณู: $(ls -1 Series/Seasons/*.json 2>/dev/null | wc -l || echo '0')"
            
            if ls Series/Seasons/*.json 1> /dev/null 2>&1; then
              first_season=$(ls Series/Seasons/*.json | head -1)
              echo ""
              echo "๐ธ ูุซุงู ูู ููู ููุงุณู:"
              echo "   ุงูููู: $(basename $first_season)"
              cat $first_season | jq '{seriesId: .seriesId, totalSeasons: .totalSeasons}'
            fi
          else
            echo "โ ูุฌูุฏ Seasons ุบูุฑ ููุฌูุฏ"
          fi

      - name: Display episodes statistics
        run: |
          echo ""
          echo "๐ฌ ุฅุญุตุงุฆูุงุช ุงูุญููุงุช:"
          if [ -d "Series/Episodes" ]; then
            echo "๐ ุนุฏุฏ ูููุงุช ุงูุญููุงุช: $(ls -1 Series/Episodes/*.json 2>/dev/null | wc -l || echo '0')"
            
            if ls Series/Episodes/*.json 1> /dev/null 2>&1; then
              first_episode=$(ls Series/Episodes/*.json | head -1)
              echo ""
              echo "๐ธ ูุซุงู ูู ููู ุญููุงุช:"
              echo "   ุงูููู: $(basename $first_episode)"
              cat $first_episode | jq '{seasonId: .seasonId, totalEpisodes: .totalEpisodes}'
            fi
          else
            echo "โ ูุฌูุฏ Episodes ุบูุฑ ููุฌูุฏ"
          fi

      - name: Generate summary report
        run: |
          echo ""
          echo "๐ ====== ุงูุชูุฑูุฑ ุงูููุงุฆู ======"
          
          total_series=0
          total_seasons=0
          total_episodes=0
          
          if [ -f "Series/Series/Hg.json" ]; then
            total_series=$(cat Series/Series/Hg.json | jq '.totalSeries // 0')
            echo "๐ฏ ุนุฏุฏ ุงููุณูุณูุงุช: $total_series"
          fi
          
          if [ -d "Series/Seasons" ]; then
            total_seasons=$(ls Series/Seasons/*.json 2>/dev/null | wc -l || echo 0)
            echo "๐ ุนุฏุฏ ูููุงุช ุงูููุงุณู: $total_seasons"
          fi
          
          if [ -d "Series/Episodes" ]; then
            total_episodes=$(ls Series/Episodes/*.json 2>/dev/null | wc -l || echo 0)
            echo "๐ฌ ุนุฏุฏ ูููุงุช ุงูุญููุงุช: $total_episodes"
          fi
          
          echo ""
          echo "๐ ููุช ุงูุงูุชูุงุก: $(date)"
          echo "โ ุงูุนูููุฉ ุงูุชููุช ุจูุฌุงุญ!"

      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # ุฅุถุงูุฉ ุฌููุน ุงูุชุบููุฑุงุช ูู ูุฌูุฏ Series
          git add Series/ || echo "โ๏ธ ูุง ุชูุฌุฏ ูููุงุช ุฌุฏูุฏุฉ"
          git add daily_Series.js || echo "โ๏ธ daily_Series.js ูู ูุชุบูุฑ"
          
          # ุงูุชุญูู ุฅุฐุง ูุงูุช ููุงู ุชุบููุฑุงุช
          if git diff --cached --quiet; then
            echo "๐ญ ูุง ุชูุฌุฏ ุชุบููุฑุงุช ููุฑูุน"
          else
            echo "๐ผ ุฑูุน ุงูุชุบููุฑุงุช..."
            git commit -m "๐บ ุชุญุฏูุซ ุงููุณูุณูุงุช - $(date +'%Y-%m-%d %H:%M')" -m "ุชู ุงุณุชุฎุฑุงุฌ ุงููุณูุณูุงุช ุชููุงุฆูุงู - ุฌุฏููุฉ ููููุฉ"
            git push
            echo "โ ุชู ุฑูุน ุงูุชุบููุฑุงุช"
          fi
