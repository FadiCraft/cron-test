name: Ù…Ø³ØªØ®Ø±Ø¬ Ù…Ø³Ù„Ø³Ù„Ø§Øª

on:
  workflow_dispatch:
  schedule:
    # ØªØ´ØºÙŠÙ„ ÙƒÙ„ Ø³Ø§Ø¹Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© 0 (Ø¹Ù„Ù‰ Ø³Ø¨ÙŠÙ„ Ø§Ù„Ù…Ø«Ø§Ù„: 1:00, 2:00, 3:00...)
    - cron: "0 * * * *"

jobs:
  extract-series:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: |
          npm init -y
          npm install jsdom
          echo "âœ… ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„Ø­Ø²Ù…"

      - name: Create necessary directories
        run: |
          mkdir -p Series/AgSeries/TV_Series
          mkdir -p Series/AgSeries/Seasons
          mkdir -p Series/AgSeries/Episodes
          echo "ğŸ“ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ†"

      - name: Pull latest changes BEFORE running script
        run: |
          echo "ğŸ“¥ Ø³Ø­Ø¨ Ø£Ø­Ø¯Ø« Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª..."
          git pull origin main --rebase || echo "âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø³Ø­Ø¨ - Ø³ÙŠØªÙ… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©"

      - name: Run the series scraper
        run: |
          echo "ğŸš€ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø³Ù„Ø³Ù„Ø§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©..."
          echo "ğŸ“… Ø§Ù„ÙˆÙ‚Øª: $(date)"
          echo "ğŸ”— Ø§Ù„Ø±Ø§Ø¨Ø·: https://topcinema.rip/category/%d9%85%d8%b3%d9%84%d8%b3%d9%84%d8%a7%d8%aa-%d8%a7%d8%ac%d9%86%d8%a8%d9%8a/"
          node daily_Series.js
          echo "âœ… ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø³Ù„Ø³Ù„Ø§Øª"

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Add and commit changes
        run: |
          # Ø¥Ø¶Ø§ÙØ© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ§Ù„Ù…Ø¹Ø¯Ù„Ø©
          git add -A
          
          if git diff --cached --quiet; then
            echo "ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ù„Ù„Ø±ÙØ¹"
          else
            # Ø§Ø³ØªØ®Ø¯Ø§Ù… commit Ù…Ø¹ ÙˆØµÙ Ù…ÙØµÙ„
            git commit -m "ğŸ“º ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³Ù„Ø³Ù„Ø§Øª - $(date +'%H:%M %d-%m-%Y')" -m "ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù…Ø³Ù„Ø³Ù„Ø§Øª ÙˆØ§Ù„Ù…ÙˆØ§Ø³Ù… ÙˆØ§Ù„Ø­Ù„Ù‚Ø§Øª"
            echo "âœ… ØªÙ… commit Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª"
          fi

      - name: Push changes (with retry)
        run: |
          if git log origin/main..HEAD --oneline | grep -q .; then
            echo "ğŸ”¼ Ø±ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª..."
            
            # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ù…Ø¹ Ø§Ù„Ø³Ø­Ø¨ Ø£ÙˆÙ„Ø§Ù‹ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
            git pull origin main --rebase || echo "âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø³Ø­Ø¨ - Ø³ÙŠØªÙ… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©"
            
            # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¯ÙØ¹
            if git push origin main; then
              echo "âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­"
            else
              echo "ğŸ”„ ÙØ´Ù„ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø£ÙˆÙ„ÙŠ - Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¹ force"
              git pull origin main
              git push origin main
            fi
          else
            echo "ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ù„Ù„Ø±ÙØ¹"
          fi
