name: ุงุณุชุฎุฑุงุฌ ูุจุงุฑูุงุช

on:
  workflow_dispatch:
  schedule:
    # ุชุดุบูู ูู 10 ุฏูุงุฆู
    - cron: "*/10 * * * *"  # ูู 10 ุฏูุงุฆู

jobs:
  extract-football-matches:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: |
          npm install jsdom
          echo "โ ุชู ุชุซุจูุช ุงูุญุฒู ุงููุทููุจุฉ"

      - name: Create football directory
        run: |
          # ุฅูุดุงุก ูุฌูุฏ football ูุณุจูุงู
          mkdir -p football
          echo "๐ ุชู ุฅูุดุงุก ูุฌูุฏ football"

      - name: Run football.js
        run: |
          echo "โฝ ุจุฏุก ุงุณุชุฎุฑุงุฌ ุงููุจุงุฑูุงุช..."
          echo "๐ ุงูููุช: $(date)"
          echo "โฐ ุงูุฌุฏููุฉ: ูู 10 ุฏูุงุฆู"
          echo "๐ ุงูููู: football.js"
          echo "๐ ุฌุงุฑู ุงูุชุดุบูู..."
          
          # ุชุดุบูู ููู football.js
          if [ -f "football.js" ]; then
            node football.js
            EXIT_CODE=$?
            if [ $EXIT_CODE -eq 0 ]; then
              echo "โ ุชู ุชุดุบูู football.js ุจูุฌุงุญ"
            else
              echo "โ football.js ุฎุฑุฌ ุจุฑูุฒ ุฎุทุฃ: $EXIT_CODE"
              exit $EXIT_CODE
            fi
          else
            echo "โ ููู football.js ุบูุฑ ููุฌูุฏ!"
            echo "๐ ุงููููุงุช ุงูููุฌูุฏุฉ:"
            ls -la *.js || echo "ูุง ุชูุฌุฏ ูููุงุช js"
            exit 1
          fi
          
          echo "โ ุชู ุงูุงูุชูุงุก ูู ุงุณุชุฎุฑุงุฌ ุงููุจุงุฑูุงุช"

      - name: Check results
        run: |
          echo "๐ ====== ูุชุงุฆุฌ ุงุณุชุฎุฑุงุฌ ุงููุจุงุฑูุงุช ======"
          echo "โฐ ููุช ุงูุชุดุบูู: $(date)"
          echo "๐ ุงูุชูุฑุงุฑ: ูู 10 ุฏูุงุฆู"
          
          # ุงูุชุญูู ูู ูุฌูุฏ ููู Hg.json
          if [ -f "football/Hg.json" ]; then
            echo "โ ุชู ุฅูุดุงุก/ุชุญุฏูุซ ููู football/Hg.json"
            
            # ุนุฑุถ ุญุฌู ุงูููู
            FILE_SIZE=$(wc -c < football/Hg.json)
            echo "๐ ุญุฌู ุงูููู: $FILE_SIZE ุจุงูุช"
            
            # ุนุฑุถ ุขุฎุฑ ููุช ุชุญุฏูุซ
            LAST_MODIFIED=$(stat -c %y football/Hg.json 2>/dev/null || date -r football/Hg.json)
            echo "๐ ุขุฎุฑ ุชุญุฏูุซ: $LAST_MODIFIED"
            
            # ุชุซุจูุช jq ุฅุฐุง ูู ููู ูุซุจุชุงู
            if ! command -v jq &> /dev/null; then
              echo "๐ฆ ุชุซุจูุช jq ูุนุฑุถ ุงูุจูุงูุงุช..."
              sudo apt-get update && sudo apt-get install -y jq
            fi
            
            # ุนุฑุถ ูุนูููุงุช ุนุงูุฉ ุนู ุงูููู
            echo ""
            echo "๐ ูุนูููุงุช ุงูููู:"
            if jq -e '.totalMatches' football/Hg.json > /dev/null 2>&1; then
              TOTAL_MATCHES=$(jq -r '.totalMatches' football/Hg.json)
              SCRAPED_AT=$(jq -r '.scrapedAt' football/Hg.json)
              echo "๐ฏ ุฅุฌูุงูู ุงููุจุงุฑูุงุช: $TOTAL_MATCHES"
              echo "โฐ ููุช ุงูุงุณุชุฎุฑุงุฌ: $SCRAPED_AT"
              
              # ุนุฏ ุงููุจุงุฑูุงุช ุงูุชู ุชุญุชูู ุนูู ุณูุฑูุฑุงุช ูุดุงูุฏุฉ
              if jq -e '.matches[] | select(.watchServers != null) | length' football/Hg.json > /dev/null 2>&1; then
                WITH_SERVERS=$(jq '[.matches[] | select(.watchServers != null)] | length' football/Hg.json)
                echo "๐บ ูุจุงุฑูุงุช ูุน ุณูุฑูุฑุงุช ูุดุงูุฏุฉ: $WITH_SERVERS"
                echo "โ ูุจุงุฑูุงุช ุจุฏูู ุณูุฑูุฑุงุช: $((TOTAL_MATCHES - WITH_SERVERS))"
              fi
              
              # ุนุฑุถ ุฃูู 3 ูุจุงุฑูุงุช
              echo ""
              echo "โฝ ุฃูู 3 ูุจุงุฑูุงุช ูุณุชุฎุฑุฌุฉ:"
              jq -r '.matches[0:3] | .[] | "  - \(.title) (\(.status)) | ุงููุชูุฌุฉ: \(.score) | ุงูุจุทููุฉ: \(.tournament)"' football/Hg.json
              
            else
              echo "โ๏ธ ูููู JSON ุบูุฑ ุตุงูุญ ุฃู ูุง ูุญุชูู ุนูู ุงูุจูุงูุงุช ุงููุชููุนุฉ"
            fi
            
          else
            echo "โ ูู ูุชู ุฅูุดุงุก football/Hg.json"
            echo "๐ ูุญุชููุงุช ูุฌูุฏ football:"
            if [ -d "football" ]; then
              ls -la football/
            else
              echo "โ ูุฌูุฏ football ุบูุฑ ููุฌูุฏ"
            fi
          fi

      - name: Commit and push changes
        run: |
          # ุชูููู Git
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # ุฅุถุงูุฉ ุงูุชุบููุฑุงุช
          git add football/Hg.json || echo "โ๏ธ ูุง ููุฌุฏ Hg.json ุฌุฏูุฏ"
          git add football/error.json 2>/dev/null || echo "โ๏ธ ูุง ููุฌุฏ error.json"
          
          # ุงูุชุญูู ุฅุฐุง ูุงูุช ููุงู ุชุบููุฑุงุช
          if git diff --cached --quiet; then
            echo "๐ญ ูุง ุชูุฌุฏ ุชุบููุฑุงุช ุฌุฏูุฏุฉ ููุฑูุน"
          else
            echo "๐ผ ุฑูุน ุงูุชุบููุฑุงุช..."
            git commit -m "โฝ ุชุญุฏูุซ ุงููุจุงุฑูุงุช - $(date +'%Y-%m-%d %H:%M')" -m "ุชุญุฏูุซ ุชููุงุฆู ูู 10 ุฏูุงุฆู" -m "ุนุฏุฏ ุงููุจุงุฑูุงุช: $(jq -r '.totalMatches // 0' football/Hg.json 2>/dev/null || echo 0)"
            git push
            echo "โ ุชู ุฑูุน ุงูุชุบููุฑุงุช"
          fi

      - name: Create log file
        run: |
          # ุฅูุดุงุก ููู ุณุฌู
          TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
          LOG_FILE="football/scrape_log.json"
          
          # ูุฑุงุกุฉ ุงูุจูุงูุงุช ุงูุญุงููุฉ ุฃู ุฅูุดุงุก ูุตูููุฉ ูุงุฑุบุฉ
          if [ -f "$LOG_FILE" ]; then
            # ุฅุถุงูุฉ ุณุฌู ุฌุฏูุฏ
            jq --arg timestamp "$TIMESTAMP" \
               --arg total "$(jq -r '.totalMatches // 0' football/Hg.json 2>/dev/null || echo 0)" \
               '. += [{"timestamp": $timestamp, "total_matches": $total|tonumber, "file_size": '$(wc -c < football/Hg.json 2>/dev/null || echo 0)'}]' \
               "$LOG_FILE" > "$LOG_FILE.tmp" && mv "$LOG_FILE.tmp" "$LOG_FILE"
          else
            # ุฅูุดุงุก ููู ุณุฌู ุฌุฏูุฏ
            echo '[{"timestamp": "'$TIMESTAMP'", "total_matches": '$(jq -r '.totalMatches // 0' football/Hg.json 2>/dev/null || echo 0)', "file_size": '$(wc -c < football/Hg.json 2>/dev/null || echo 0)'}]' > "$LOG_FILE"
          fi
          
          # ุฅุถุงูุฉ ููู ุงูุณุฌู ุฅูู Git
          git add "$LOG_FILE"
          git commit -m "๐ ุชุญุฏูุซ ุณุฌู ุงูุชุดุบูู - $TIMESTAMP" || echo "โ๏ธ ูุง ุชูุฌุฏ ุชุบููุฑุงุช ูู ุงูุณุฌู"
          git push || echo "โ๏ธ ูุง ุชูุฌุฏ ุชุบููุฑุงุช ููุฑูุน"

      - name: Clean up old logs (ูุฑุฉ ููููุงู)
        if: github.event.schedule == '*/10 * * * *'
        run: |
          # ุชูุธูู ุงูุณุฌูุงุช ุงููุฏููุฉ (ุชุญุชูุธ ุจู 100 ุณุฌู ููุท)
          LOG_FILE="football/scrape_log.json"
          if [ -f "$LOG_FILE" ]; then
            jq '.[-100:]' "$LOG_FILE" > "$LOG_FILE.tmp" && mv "$LOG_FILE.tmp" "$LOG_FILE"
            echo "๐งน ุชู ุชูุธูู ุงูุณุฌูุงุช (ุจูู 100 ุณุฌู ููุท)"
          fi
