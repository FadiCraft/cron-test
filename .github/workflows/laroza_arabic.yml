name: Laroza Arabic Movies Scraper

on:
  schedule:
    - cron: "0 */6 * * *"  # ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª
  workflow_dispatch:  # ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Install dependencies
        run: |
          npm init -y
          npm install axios cheerio

      - name: ğŸ“‚ Create necessary directories
        run: |
          mkdir -p Larozaa/ArabicMovies
          echo "ğŸ“ Created directories:"
          ls -la Larozaa/ArabicMovies/

      - name: ğŸ¬ Create scraper script
        run: |
          cat > laroza_arabic.js << 'EOF'
          // Ù‡Ù†Ø§ Ø¶Ø¹ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø³ÙƒØ±ÙŠØ¨Øª (Ø§Ù„Ø°ÙŠ Ø£Ø±Ø³Ù„ØªÙ‡ Ø³Ø§Ø¨Ù‚Ø§Ù‹)
          EOF

      - name: ğŸš€ Run Laroza scraper
        id: scrape
        run: |
          echo "ğŸš€ Starting Laroza scraper..."
          echo "â±ï¸ Start time: $(date)"
          
          # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª
          node laroza_arabic.js 2>&1 | tee scraper_output.log
          
          echo "â±ï¸ End time: $(date)"

      - name: ğŸ“Š Show results
        run: |
          echo "ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ´ØºÙŠÙ„:"
          echo "=================="
          echo "ğŸ“ Larozaa folder:"
          ls -la Larozaa/
          echo "=================="
          echo "ğŸ¬ ArabicMovies folder:"
          ls -la Larozaa/ArabicMovies/ || true
          echo "=================="
          echo "ğŸ“„ Home.json:"
          cat Larozaa/ArabicMovies/Home.json 2>/dev/null || echo "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Home.json Ø¨Ø¹Ø¯"
          echo "=================="
          echo "ğŸ“Š Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©:"
          find Larozaa/ArabicMovies -name "*.json" | wc -l

      - name: ğŸ’¾ Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ .gitignore
          if [ ! -f ".gitignore" ]; then
            echo "node_modules/" > .gitignore
            echo "Larozaa/" >> .gitignore
          fi
          
          # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙ‚Ø·
          git add Larozaa/
          git add *.js
          
          # Ø¹Ù…Ù„ commit Ø¥Ø°Ø§ ÙÙŠÙ‡ ØªØºÙŠÙŠØ±Ø§Øª
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit"
          else
            # Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙÙ„Ø§Ù…
            MOVIES_COUNT=$(find Larozaa/ArabicMovies -name "*.json" -exec cat {} \; | grep -c '"title"' || echo 0)
            
            git commit -m "ğŸ¤– Laroza update - $(date +'%Y-%m-%d %H:%M') - $MOVIES_COUNT movies"
            git push
            echo "âœ… Changes pushed successfully"
          fi

      - name: ğŸ“¤ Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: laroza-logs
          path: |
            scraper_output.log
            Larozaa/ArabicMovies/*.json
          retention-days: 7
