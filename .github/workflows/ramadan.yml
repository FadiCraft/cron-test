name: KiroZozo Daily Movie Extractor

on:
  workflow_dispatch:
  schedule:
    # ุชุดุบูู ูู ููู ุนูุฏ ุงูุณุงุนุฉ 2 ุตุจุงุญุงู UTC
    - cron: "0 2 * * *"  # ูู ููู ูู ุงูุณุงุนุฉ 2 ุตุจุงุญุงู

jobs:
  extract-daily:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: |
          npm install jsdom
          echo "โ ุชู ุชุซุจูุช ุงูุญุฒู"

      - name: Create necessary directories
        run: |
          # ุฅูุดุงุก ูุฌูุฏ movies ูุณุจูุงู
          mkdir -p movies
          mkdir -p Ramadan
          echo "๐ ุชู ุฅูุดุงุก ุงููุฌูุฏุงุช ุงููุทููุจุฉ"

      - name: Run movie extraction script
        run: |
          echo "๐ ุจุฏุก ุนูููุฉ ุงูุงุณุชุฎุฑุงุฌ ุงููููู ููุฃููุงู..."
          echo "๐ ุงูููุช: $(date)"
          echo "๐ ุงูุฌุฏููุฉ: ูู ููู ูู ุงูุณุงุนุฉ 2 ุตุจุงุญุงู UTC"
          echo "๐ ุฌุงุฑู ุงูุชุดุบูู..."
          
          # ุชุดุบูู ููู fetch_daily.js (ุงูููุฏ ุงูุฃูู)
          if [ -f "fetch_daily.js" ]; then
            node fetch_daily.js
            EXIT_CODE=$?
            if [ $EXIT_CODE -eq 0 ]; then
              echo "โ ุชู ุชุดุบูู fetch_daily.js ุจูุฌุงุญ"
            else
              echo "โ ุญุฏุซ ุฎุทุฃ ูู ุชุดุบูู fetch_daily.js"
              exit $EXIT_CODE
            fi
          else
            echo "โ ููู fetch_daily.js ุบูุฑ ููุฌูุฏ!"
            echo "๐ ุงููููุงุช ุงูููุฌูุฏุฉ:"
            ls -la *.js || echo "ูุง ุชูุฌุฏ ูููุงุช js"
            exit 1
          fi

      - name: Check movie extraction results
        run: |
          echo "๐ ====== ูุชุงุฆุฌ ุงุณุชุฎุฑุงุฌ ุงูุฃููุงู ======"
          echo "โฐ ููุช ุงูุชุดุบูู: $(date)"
          
          # ุงูุชุญูู ูู ูุฌูุฏ ููู Hg.json
          if [ -f "movies/Hg.json" ]; then
            echo "โ ุชู ุฅูุดุงุก ููู movies/Hg.json"
            MOVIE_COUNT=$(jq '.movies | length' movies/Hg.json 2>/dev/null || echo "ุบูุฑ ูุญุฏุฏ")
            echo "๐ฌ ุนุฏุฏ ุงูุฃููุงู: $MOVIE_COUNT"
            echo "๐ ุญุฌู ุงูููู: $(wc -c < movies/Hg.json | numfmt --to=iec) ุจุงูุช"
            
            # ุนุฑุถ ูุนูููุงุช ุนู ุงูููู
            echo ""
            echo "๐ ูุนูููุงุช ุงูููู:"
            jq -n --arg file "movies/Hg.json" \
                  --arg time "$(date)" \
                  --arg count "$MOVIE_COUNT" \
                  --arg size "$(wc -c < movies/Hg.json)" \
                  '{ููู: $file, ููุช_ุงูุชุดุบูู: $time, ุนุฏุฏ_ุงูุฃููุงู: $count, ุญุฌู_ุงูููู: $size, ุงูุญุงูุฉ: "โ ุฌุงูุฒ"}'
            
            # ุนุฑุถ ุฃูู 3 ุฃููุงู
            echo ""
            echo "๐ฅ ุฃูู 3 ุฃููุงู ูุณุชุฎุฑุฌุฉ:"
            if command -v jq &> /dev/null; then
              jq '.movies[0:3] | map({id: .id, title: .title, imdbRating: .imdbRating, quality: .details.quality})' movies/Hg.json
            else
              echo "โ jq ุบูุฑ ูุซุจุชุ ุชุซุจูุชู..."
              sudo apt-get install -y jq
              jq '.movies[0:3] | map({id: .id, title: .title, imdbRating: .imdbRating, quality: .details.quality})' movies/Hg.json
            fi
            
          else
            echo "โ ูู ูุชู ุฅูุดุงุก movies/Hg.json"
            echo "๐ ูุญุชููุงุช ูุฌูุฏ movies:"
            if [ -d "movies" ]; then
              ls -la movies/
            else
              echo "โ ูุฌูุฏ movies ุบูุฑ ููุฌูุฏ"
            fi
          fi

      - name: Run Ramadan series extraction script
        run: |
          echo ""
          echo "๐ ุจุฏุก ุนูููุฉ ุงุณุชุฎุฑุงุฌ ูุณูุณูุงุช ุฑูุถุงู..."
          echo "๐ ุงูููุช: $(date)"
          echo "๐ ุงูุณูุฉ: 2025"
          
          # ุชุดุบูู ููู Ramadan.js (ุงูููุฏ ุงูุซุงูู)
          if [ -f "Ramadan.js" ]; then
            node Ramadan.js
            EXIT_CODE=$?
            if [ $EXIT_CODE -eq 0 ]; then
              echo "โ ุชู ุชุดุบูู Ramadan.js ุจูุฌุงุญ"
            else
              echo "โ๏ธ ุญุฏุซ ุฎุทุฃ ูู ุชุดุบูู Ramadan.js"
              # ูุง ูุฎุฑุฌ ููุง ูุฃู ุงุณุชุฎุฑุงุฌ ุงูุฃููุงู ูุงู ูุงุฌุญุงู
            fi
          else
            echo "โ๏ธ ููู Ramadan.js ุบูุฑ ููุฌูุฏ - ุชุฎุทู ุงุณุชุฎุฑุงุฌ ูุณูุณูุงุช ุฑูุถุงู"
          fi

      - name: Check Ramadan extraction results
        run: |
          echo ""
          echo "๐ ====== ูุชุงุฆุฌ ุงุณุชุฎุฑุงุฌ ูุณูุณูุงุช ุฑูุถุงู ======"
          
          # ุงูุชุญูู ูู ูุฌูุฏ ููู Ramadan2025.json
          if [ -f "Ramadan/2025/Ramadan2025.json" ]; then
            echo "โ ุชู ุฅูุดุงุก ููู Ramadan/2025/Ramadan2025.json"
            SERIES_COUNT=$(jq '.series | length' Ramadan/2025/Ramadan2025.json 2>/dev/null || echo "ุบูุฑ ูุญุฏุฏ")
            EPISODE_COUNT=$(jq '[.series[].episodes | length] | add' Ramadan/2025/Ramadan2025.json 2>/dev/null || echo "ุบูุฑ ูุญุฏุฏ")
            
            echo "๐บ ุนุฏุฏ ุงููุณูุณูุงุช: $SERIES_COUNT"
            echo "๐ฌ ุนุฏุฏ ุงูุญููุงุช: $EPISODE_COUNT"
            echo "๐ ุญุฌู ุงูููู: $(wc -c < Ramadan/2025/Ramadan2025.json | numfmt --to=iec) ุจุงูุช"
            
            # ุนุฑุถ ุนููุฉ ูู ุงููุณูุณูุงุช
            echo ""
            echo "๐ ุนููุฉ ูู ุงููุณูุณูุงุช:"
            jq '.series[0:2] | map({title: .seriesTitle, episodes: .totalEpisodes})' Ramadan/2025/Ramadan2025.json
            
          else
            echo "โ๏ธ ูู ูุชู ุฅูุดุงุก ููู ูุณูุณูุงุช ุฑูุถุงู"
            echo "๐ ูุญุชููุงุช ูุฌูุฏ Ramadan:"
            if [ -d "Ramadan" ]; then
              find Ramadan -name "*.json" -type f
            else
              echo "๐ ูุฌูุฏ Ramadan ุบูุฑ ููุฌูุฏ"
            fi
          fi

      - name: Generate summary report
        run: |
          echo ""
          echo "๐ ====== ุชูุฑูุฑ ููุฎุต ======"
          echo "โฐ ููุช ุงูุชุดุบูู: $(date)"
          
          # ุฅูุดุงุก ุชูุฑูุฑ ููุฎุต
          SUMMARY_FILE="summary_$(date +%Y%m%d_%H%M%S).json"
          
          MOVIE_COUNT=0
          MOVIE_FILE_EXISTS=false
          if [ -f "movies/Hg.json" ]; then
            MOVIE_COUNT=$(jq '.movies | length' movies/Hg.json 2>/dev/null || echo "0")
            MOVIE_FILE_EXISTS=true
          fi
          
          RAMADAN_SERIES_COUNT=0
          RAMADAN_EPISODE_COUNT=0
          RAMADAN_FILE_EXISTS=false
          if [ -f "Ramadan/2025/Ramadan2025.json" ]; then
            RAMADAN_SERIES_COUNT=$(jq '.series | length' Ramadan/2025/Ramadan2025.json 2>/dev/null || echo "0")
            RAMADAN_EPISODE_COUNT=$(jq '[.series[].episodes | length] | add' Ramadan/2025/Ramadan2025.json 2>/dev/null || echo "0")
            RAMADAN_FILE_EXISTS=true
          fi
          
          cat > "$SUMMARY_FILE" << EOF
{
  "date": "$(date)",
  "movies": {
    "file_exists": $MOVIE_FILE_EXISTS,
    "count": $MOVIE_COUNT,
    "file": "movies/Hg.json"
  },
  "ramadan_series": {
    "file_exists": $RAMADAN_FILE_EXISTS,
    "series_count": $RAMADAN_SERIES_COUNT,
    "episode_count": $RAMADAN_EPISODE_COUNT,
    "file": "Ramadan/2025/Ramadan2025.json"
  },
  "total_items": $(($MOVIE_COUNT + $RAMADAN_EPISODE_COUNT)),
  "status": "completed"
}
EOF
          
          echo "๐ ุงูุชูุฑูุฑ ุงูููุฎุต ูุญููุธ ูู: $SUMMARY_FILE"
          cat "$SUMMARY_FILE"

      - name: Commit and push all changes
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # ุฅุถุงูุฉ ุฌููุน ุงูุชุบููุฑุงุช
          echo "โ ุฅุถุงูุฉ ุงูุชุบููุฑุงุช..."
          git add movies/Hg.json movies/*.json || echo "โ๏ธ ูุง ููุฌุฏ ูููุงุช ุฃููุงู ุฌุฏูุฏุฉ"
          git add Ramadan/ || echo "โ๏ธ ูุง ููุฌุฏ ูููุงุช ุฑูุถุงู ุฌุฏูุฏุฉ"
          git add summary_*.json || echo "โ๏ธ ูุง ููุฌุฏ ุชูุงุฑูุฑ ููุฎุตุฉ ุฌุฏูุฏุฉ"
          
          # ุงูุชุญูู ุฅุฐุง ูุงูุช ููุงู ุชุบููุฑุงุช
          if git diff --cached --quiet; then
            echo "๐ญ ูุง ุชูุฌุฏ ุชุบููุฑุงุช ุฌุฏูุฏุฉ ููุฑูุน"
          else
            echo "๐ผ ุฑูุน ุงูุชุบููุฑุงุช ุงูููููุฉ..."
            
            # ุฅูุดุงุก ุฑุณุงูุฉ commit ุชูุตูููุฉ
            MOVIE_COUNT=$(jq '.movies | length' movies/Hg.json 2>/dev/null || echo "0")
            RAMADAN_INFO=""
            if [ -f "Ramadan/2025/Ramadan2025.json" ]; then
              SERIES_COUNT=$(jq '.series | length' Ramadan/2025/Ramadan2025.json 2>/dev/null || echo "0")
              EPISODE_COUNT=$(jq '[.series[].episodes | length] | add' Ramadan/2025/Ramadan2025.json 2>/dev/null || echo "0")
              RAMADAN_INFO=" | ุฑูุถุงู: $SERIES_COUNT ูุณูุณู ($EPISODE_COUNT ุญููุฉ)"
            fi
            
            COMMIT_MSG="๐ฌ ุชุญุฏูุซ ุงูุจูุงูุงุช ุงููููู - $(date +'%Y-%m-%d')
            
            ๐ ุงูุฅุญุตุงุฆูุงุช:
            โข ุงูุฃููุงู: $MOVIE_COUNT ูููู
            $([ -n "$RAMADAN_INFO" ] && echo "โข $RAMADAN_INFO")
            
            โฐ ุงูููุช: $(date +'%H:%M:%S')
            ๐ค ุชู ุงูุชุดุบูู ุชููุงุฆูุงู ุนุจุฑ GitHub Actions"
            
            git commit -m "$COMMIT_MSG"
            git push
            echo "โ ุชู ุฑูุน ุงูุชุบููุฑุงุช ุงูููููุฉ"
          fi

      - name: Clean up temporary files
        run: |
          echo "๐งน ุชูุธูู ุงููููุงุช ุงููุคูุชุฉ..."
          rm -f summary_*.json 2>/dev/null || true
          echo "โ ุชู ุงูุชูุธูู"
