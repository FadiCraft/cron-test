name: KiroZozo Ramadan Series Extractor

on:
  workflow_dispatch:
  schedule:
    # ØªØ´ØºÙŠÙ„ ÙƒÙ„ ÙŠÙˆÙ… Ø®Ù„Ø§Ù„ Ø±Ù…Ø¶Ø§Ù†
    - cron: "0 2 * * *"  # ÙƒÙ„ ÙŠÙˆÙ… ÙÙŠ Ø§Ù„Ø³Ø§Ø¹Ø© 2 ØµØ¨Ø§Ø­Ø§Ù‹ UTC

jobs:
  extract-ramadan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: |
          npm install jsdom
          echo "âœ… ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„Ø­Ø²Ù…"

      - name: Create series directory
        run: |
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ù…Ø³Ù„Ø³Ù„Ø§Øª
          mkdir -p series
          echo "ğŸ“ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ series"

      - name: Run Ramadan.js
        run: |
          echo "ğŸš€ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø³Ù„Ø³Ù„Ø§Øª Ø±Ù…Ø¶Ø§Ù†..."
          echo "ğŸ“… Ø§Ù„ÙˆÙ‚Øª: $(date)"
          echo "ğŸ“… Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©: ÙƒÙ„ ÙŠÙˆÙ… ÙÙŠ Ø§Ù„Ø³Ø§Ø¹Ø© 2 ØµØ¨Ø§Ø­Ø§Ù‹ UTC"
          echo "ğŸ“ Ø§Ù„Ù…Ù„Ù: Ramadan.js"
          echo "ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„..."
          
          # ØªØ´ØºÙŠÙ„ Ù…Ù„Ù Ramadan.js
          if [ -f "Ramadan.js" ]; then
            node Ramadan.js
            echo "âœ… ØªÙ… ØªØ´ØºÙŠÙ„ Ramadan.js Ø¨Ù†Ø¬Ø§Ø­"
          else
            echo "âŒ Ù…Ù„Ù Ramadan.js ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!"
            echo "ğŸ“‚ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©:"
            ls -la *.js || echo "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª js"
            exit 1
          fi
          
          echo "âœ… ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø³Ù„Ø³Ù„Ø§Øª"

      - name: Check results
        run: |
          echo "ğŸ“Š ====== Ù†ØªØ§Ø¦Ø¬ Ù…Ø³Ù„Ø³Ù„Ø§Øª Ø±Ù…Ø¶Ø§Ù† ======"
          echo "â° ÙˆÙ‚Øª Ø§Ù„ØªØ´ØºÙŠÙ„: $(date)"
          echo "ğŸŒ™ Ø±Ù…Ø¶Ø§Ù† Ù…Ø¨Ø§Ø±Ùƒ!"
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù†Ø§ØªØ¬
          if [ -f "series/ramadan_series.json" ]; then
            echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù series/ramadan_series.json"
            echo "ğŸ“Š Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù: $(wc -c < series/ramadan_series.json) Ø¨Ø§ÙŠØª"
            
            # Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ù…Ù„Ù
            echo ""
            echo "ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„Ù:"
            echo '{
              "Ù…Ù„Ù": "series/ramadan_series.json",
              "Ù†ÙˆØ¹_Ø§Ù„Ù…Ø­ØªÙˆÙ‰": "Ù…Ø³Ù„Ø³Ù„Ø§Øª Ø±Ù…Ø¶Ø§Ù†",
              "ÙˆÙ‚Øª_Ø§Ù„ØªØ´ØºÙŠÙ„": "'$(date)'",
              "Ø§Ù„Ø­Ø§Ù„Ø©": "âœ… Ø¬Ø§Ù‡Ø²"
            }' | jq .
            
            # Ø¹Ø±Ø¶ Ø£ÙˆÙ„ 3 Ù…Ø³Ù„Ø³Ù„Ø§Øª
            echo ""
            echo "ğŸ“º Ø£ÙˆÙ„ 3 Ù…Ø³Ù„Ø³Ù„Ø§Øª Ù…Ø³ØªØ®Ø±Ø¬Ø©:"
            if command -v jq &> /dev/null; then
              jq '.series[0:3]' series/ramadan_series.json || echo "âš ï¸ Ù‡ÙŠÙƒÙ„ JSON Ù…Ø®ØªÙ„Ù"
            else
              echo "âŒ jq ØºÙŠØ± Ù…Ø«Ø¨ØªØŒ ØªØ«Ø¨ÙŠØªÙ‡..."
              sudo apt-get install -y jq
              jq '.series[0:3]' series/ramadan_series.json || echo "âš ï¸ Ù‡ÙŠÙƒÙ„ JSON Ù…Ø®ØªÙ„Ù"
            fi
            
          elif [ -f "ramadan.json" ]; then
            echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù ramadan.json"
            echo "ğŸ“Š Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù: $(wc -c < ramadan.json) Ø¨Ø§ÙŠØª"
            echo "âš ï¸ Ø§Ù„Ù…Ù„Ù ÙÙŠ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙˆÙ„ÙŠØ³ ÙÙŠ series/"
            
          else
            echo "âŒ Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ù…Ø³Ù„Ø³Ù„Ø§Øª"
            echo "ğŸ“‚ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ:"
            ls -la *.json || echo "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª json"
            echo "ğŸ“‚ Ù…Ø­ØªÙˆÙŠØ§Øª Ù…Ø¬Ù„Ø¯ series:"
            ls -la series/ 2>/dev/null || echo "âŒ Ù…Ø¬Ù„Ø¯ series ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"
          fi

      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
          git add series/ramadan_series.json || git add ramadan.json || echo "âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù Ù…Ø³Ù„Ø³Ù„Ø§Øª Ø¬Ø¯ÙŠØ¯"
          git add series/*.json || echo "âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª json ÙÙŠ series/"
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ ØªØºÙŠÙŠØ±Ø§Øª
          if git diff --cached --quiet; then
            echo "ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø±ÙØ¹"
          else
            echo "ğŸ”¼ Ø±ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©..."
            git commit -m "ğŸ“º ØªØ­Ø¯ÙŠØ« Ù…Ø³Ù„Ø³Ù„Ø§Øª Ø±Ù…Ø¶Ø§Ù† - $(date +'%Y-%m-%d')" -m "ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø³Ù„Ø³Ù„Ø§Øª Ø±Ù…Ø¶Ø§Ù† ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ - $(date +'%H:%M')"
            git push
            echo "âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª"
          fi

      - name: Cleanup (optional)
        run: |
          echo "ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ù…Ø¤Ù‚Øª..."
          rm -f *.log tmp_*.json 2>/dev/null || true
          echo "âœ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ù…ÙƒØªÙ…Ù„"
