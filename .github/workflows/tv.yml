name: Extract MBC Channels

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  extract-channels:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # â¬…ï¸ Ù…Ù‡Ù…: ÙŠØ¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®
      
    - name: â” Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸš€ Extract channels
      run: |
        echo "=== Running tv.js ==="
        node tv.js
        echo "=== Files created ==="
        ls -la TV/ || echo "No TV directory!"
      
    - name: ğŸ“Š Commit and push changes
      run: |
        echo "=== Checking files before commit ==="
        
        # ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„ÙØ§Øª
        if [ ! -d "TV" ]; then
          echo "âŒ TV directory not found!"
          exit 1
        fi
        
        if [ ! -f "TV/tv.json" ]; then
          echo "âŒ TV/tv.json not found!"
          exit 1
        fi
        
        echo "âœ… Files found, proceeding with commit..."
        
        # Ø¥Ø¹Ø¯Ø§Ø¯ Git
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„ÙØ§Øª
        git add TV/
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        if git diff --cached --quiet; then
          echo "ğŸ“­ No changes to commit"
        else
          echo "ğŸ“ Changes detected, committing..."
          git commit -m "ğŸ“º Auto-update MBC channels - $(date '+%Y-%m-%d %H:%M') [skip ci]"
          
          # Push Ù…Ø¹ retry
          attempts=0
          max_attempts=3
          
          while [ $attempts -lt $max_attempts ]; do
            git pull --rebase
            if git push; then
              echo "âœ… Push successful"
              break
            else
              attempts=$((attempts+1))
              echo "âš ï¸ Push failed, attempt $attempts/$max_attempts"
              sleep 5
            fi
          done
          
          if [ $attempts -eq $max_attempts ]; then
            echo "âŒ All push attempts failed"
            exit 1
          fi
        fi
